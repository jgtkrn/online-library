<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>test documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">test documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li>Injectables</li>
  <li >SubscriptionService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/subscription/subscription.service.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#addFreeTrial" >addFreeTrial</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#checkIfRecordExpired" >checkIfRecordExpired</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#checkReferralCode" >checkReferralCode</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createCustomer" >createCustomer</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createPaymentMethod" >createPaymentMethod</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createSubscription" >createSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#crossPlatformSubsCheck" >crossPlatformSubsCheck</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#deleteSubscription" >deleteSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#exportCsv" >exportCsv</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getAllUserSub" >getAllUserSub</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getColumnUserPayment" >getColumnUserPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getColumnUserSubscription" >getColumnUserSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getExportDataSubscription" >getExportDataSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getMonthlyPlanProductId" >getMonthlyPlanProductId</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPaidPaymentByUserLabel" >getPaidPaymentByUserLabel</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getParamsUserPayment" >getParamsUserPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getParamsUserSubscription" >getParamsUserSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPaymentDataFromSubscribeResponse" >getPaymentDataFromSubscribeResponse</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPaymentMethod" >getPaymentMethod</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSetupIntent" >getSetupIntent</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSubPLan" >getSubPLan</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSubscription" >getSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSubscriptionByUserLabel" >getSubscriptionByUserLabel</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSubscriptionPlan" >getSubscriptionPlan</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getSubscriptionStatus" >getSubscriptionStatus</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getTrancationIdFromSubscriptionResult" >getTrancationIdFromSubscriptionResult</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserPayment" >getUserPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserSub" >getUserSub</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserSubscription" >getUserSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserSubscriptionByOrderId" >getUserSubscriptionByOrderId</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#inactiveSubscription" >inactiveSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#insertSubscriptionData" >insertSubscriptionData</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#insertUserPayment" >insertUserPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#lastPayment" >lastPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#listSubscriptionByUser" >listSubscriptionByUser</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#pausePaymentCollectionSubscription" >pausePaymentCollectionSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#previewInvoice" >previewInvoice</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#savePaymentMethod" >savePaymentMethod</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveSubscriptionLogs" >saveSubscriptionLogs</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#subscribe" >subscribe</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateSubscribe" >updateSubscribe</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateSubscription" >updateSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#upsertSubscription" >upsertSubscription</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#verifyApple" >verifyApple</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#verifyApplePurchase" >verifyApplePurchase</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#verifyGooglePurchase" >verifyGooglePurchase</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#verifySub" >verifySub</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(i18n: I18nService, response: <a href="../injectables/Response.html" target="_self">Response</a>, userService: <a href="../injectables/UsersService.html" target="_self">UsersService</a>, stripe: <a href="../classes/StripeHelper.html" target="_self">StripeHelper</a>, exportFile: <a href="../classes/ExportFile.html" target="_self">ExportFile</a>, subscriptionPlanMethodRepository: <a href="../interfaces/Subscription.html" target="_self">Repository&lt;SubscriptionPlanEntity&gt;</a>, userPaymentRepository: <a href="../interfaces/User.html" target="_self">Repository&lt;UserPaymentEntity&gt;</a>, userSubscriptionRepository: <a href="../entitys/UserSubscriptionEntity.html" target="_self">Repository&lt;UserSubscriptionEntity&gt;</a>, subscriptionLogsRepository: <a href="../entitys/SubscriptionLogsEntity.html" target="_self">Repository&lt;SubscriptionLogsEntity&gt;</a>, stripePaymentMethodRepository: <a href="../interfaces/PaymentMethod.html" target="_self">Repository&lt;StripePaymentMethodEntity&gt;</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="36" class="link-to-prism">src/modules/subscription/subscription.service.ts:36</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>i18n</td>
                                                  
                                                        <td>
                                                                    <code>I18nService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>response</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/Response.html" target="_self" >Response</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>userService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/UsersService.html" target="_self" >UsersService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>stripe</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/StripeHelper.html" target="_self" >StripeHelper</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>exportFile</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/ExportFile.html" target="_self" >ExportFile</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>subscriptionPlanMethodRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/Subscription.html" target="_self" >Repository&lt;SubscriptionPlanEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>userPaymentRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/User.html" target="_self" >Repository&lt;UserPaymentEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>userSubscriptionRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/UserSubscriptionEntity.html" target="_self" >Repository&lt;UserSubscriptionEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>subscriptionLogsRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../entitys/SubscriptionLogsEntity.html" target="_self" >Repository&lt;SubscriptionLogsEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>stripePaymentMethodRepository</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/PaymentMethod.html" target="_self" >Repository&lt;StripePaymentMethodEntity&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="addFreeTrial"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>addFreeTrial</b></span>
                        <a href="#addFreeTrial"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>addFreeTrial(subscription_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, end_date: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1795"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1795</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscription_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>end_date</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="checkIfRecordExpired"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>checkIfRecordExpired</b></span>
                        <a href="#checkIfRecordExpired"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>checkIfRecordExpired(user)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="877"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:877</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="checkReferralCode"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>checkReferralCode</b></span>
                        <a href="#checkReferralCode"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>checkReferralCode(couponId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="452"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:452</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>couponId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createCustomer"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>createCustomer</b></span>
                        <a href="#createCustomer"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createCustomer(user: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, createCustomerData: <a href="../classes/CreateCustomerDto.html" target="_self">CreateCustomerDto</a>, auth: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1509"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1509</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>createCustomerData</td>
                                    <td>
                                                <code><a href="../classes/CreateCustomerDto.html" target="_self" >CreateCustomerDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>auth</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createPaymentMethod"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>createPaymentMethod</b></span>
                        <a href="#createPaymentMethod"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createPaymentMethod(user: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, createPaymentData: <a href="../interfaces/PaymentMethod.html" target="_self">CreatePaymentMethodDto</a>, auth: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1529"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1529</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>createPaymentData</td>
                                    <td>
                                                <code><a href="../interfaces/PaymentMethod.html" target="_self" >CreatePaymentMethodDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>auth</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>createSubscription</b></span>
                        <a href="#createSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createSubscription(user: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, createSubscriptionnData: <a href="../interfaces/Subscription.html" target="_self">CreateSubscriptionDto</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1549"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1549</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>createSubscriptionnData</td>
                                    <td>
                                                <code><a href="../interfaces/Subscription.html" target="_self" >CreateSubscriptionDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="crossPlatformSubsCheck"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>crossPlatformSubsCheck</b></span>
                        <a href="#crossPlatformSubsCheck"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>crossPlatformSubsCheck(user, latestSubs: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, currency)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1319"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1319</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>
                                    <td>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>latestSubs</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>currency</td>
                                    <td>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deleteSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>deleteSubscription</b></span>
                        <a href="#deleteSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>deleteSubscription(subscription_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, user)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1686"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1686</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscription_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>user</td>
                                    <td>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="exportCsv"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>exportCsv</b></span>
                        <a href="#exportCsv"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>exportCsv(res)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1876"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1876</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>res</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAllUserSub"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getAllUserSub</b></span>
                        <a href="#getAllUserSub"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getAllUserSub(userData)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="622"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:622</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>userData</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getColumnUserPayment"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getColumnUserPayment</b></span>
                        <a href="#getColumnUserPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getColumnUserPayment(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, transaction_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, original_transaction_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="607"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:607</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>transaction_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>original_transaction_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getColumnUserSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getColumnUserSubscription</b></span>
                        <a href="#getColumnUserSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getColumnUserSubscription(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, order_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, payment_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="576"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:576</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>order_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>payment_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getExportDataSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getExportDataSubscription</b></span>
                        <a href="#getExportDataSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getExportDataSubscription()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1824"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1824</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMonthlyPlanProductId"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getMonthlyPlanProductId</b></span>
                        <a href="#getMonthlyPlanProductId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getMonthlyPlanProductId()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="458"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:458</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;String&gt;</code>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPaidPaymentByUserLabel"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getPaidPaymentByUserLabel</b></span>
                        <a href="#getPaidPaymentByUserLabel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPaidPaymentByUserLabel(user_label: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="159"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:159</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user_label</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getParamsUserPayment"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getParamsUserPayment</b></span>
                        <a href="#getParamsUserPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getParamsUserPayment(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, transaction_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, original_transaction_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="592"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:592</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>transaction_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>original_transaction_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getParamsUserSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getParamsUserSubscription</b></span>
                        <a href="#getParamsUserSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getParamsUserSubscription(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, order_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, payment_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="561"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:561</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>order_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>payment_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPaymentDataFromSubscribeResponse"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getPaymentDataFromSubscribeResponse</b></span>
                        <a href="#getPaymentDataFromSubscribeResponse"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPaymentDataFromSubscribeResponse(data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="479"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:479</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>data</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPaymentMethod"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getPaymentMethod</b></span>
                        <a href="#getPaymentMethod"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPaymentMethod(userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, stripeId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, authId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="179"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:179</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>userId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>stripeId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>authId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../interfaces/PaymentMethod.html" target="_self" >Promise&lt;PaymentMethod&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSetupIntent"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getSetupIntent</b></span>
                        <a href="#getSetupIntent"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSetupIntent(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1807"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1807</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSubPLan"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getSubPLan</b></span>
                        <a href="#getSubPLan"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSubPLan(reffCode, currency: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="776"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:776</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Default value</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>reffCode</td>
                                    <td>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                    </td>

                                </tr>
                                <tr>
                                    <td>currency</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>&#x27;HKD&#x27;</code>
                                    </td>

                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getSubscription</b></span>
                        <a href="#getSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSubscription(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, stripe_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="61"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:61</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>stripe_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSubscriptionByUserLabel"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getSubscriptionByUserLabel</b></span>
                        <a href="#getSubscriptionByUserLabel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSubscriptionByUserLabel(user_label: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="725"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:725</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user_label</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSubscriptionPlan"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getSubscriptionPlan</b></span>
                        <a href="#getSubscriptionPlan"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSubscriptionPlan(query)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="499"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:499</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>query</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getSubscriptionStatus"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getSubscriptionStatus</b></span>
                        <a href="#getSubscriptionStatus"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getSubscriptionStatus(subscription_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="703"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:703</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscription_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getTrancationIdFromSubscriptionResult"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getTrancationIdFromSubscriptionResult</b></span>
                        <a href="#getTrancationIdFromSubscriptionResult"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getTrancationIdFromSubscriptionResult(data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="447"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:447</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>data</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserPayment"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getUserPayment</b></span>
                        <a href="#getUserPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserPayment(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, trancationId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, originalTransactionId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="127"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:127</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>trancationId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>originalTransactionId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserSub"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getUserSub</b></span>
                        <a href="#getUserSub"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserSub(userData)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="662"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:662</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>userData</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getUserSubscription</b></span>
                        <a href="#getUserSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserSubscription(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, order_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, payment_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="93"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:93</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>order_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>payment_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserSubscriptionByOrderId"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getUserSubscriptionByOrderId</b></span>
                        <a href="#getUserSubscriptionByOrderId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserSubscriptionByOrderId(order_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, user_label: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="746"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:746</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>order_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>user_label</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="inactiveSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>inactiveSubscription</b></span>
                        <a href="#inactiveSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>inactiveSubscription(subcription_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="767"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:767</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subcription_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="insertSubscriptionData"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>insertSubscriptionData</b></span>
                        <a href="#insertSubscriptionData"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>insertSubscriptionData(data, userId, subscription_ref_code, referral_code)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="385"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:385</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>data</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>userId</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>subscription_ref_code</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>referral_code</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="insertUserPayment"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>insertUserPayment</b></span>
                        <a href="#insertUserPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>insertUserPayment(data, user)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="790"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:790</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>data</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="lastPayment"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>lastPayment</b></span>
                        <a href="#lastPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>lastPayment(user)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="865"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:865</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="listSubscriptionByUser"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>listSubscriptionByUser</b></span>
                        <a href="#listSubscriptionByUser"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>listSubscriptionByUser(customer_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1741"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1741</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>customer_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="pausePaymentCollectionSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>pausePaymentCollectionSubscription</b></span>
                        <a href="#pausePaymentCollectionSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>pausePaymentCollectionSubscription(subscription_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, extra_date: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1782"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1782</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscription_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>extra_date</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="previewInvoice"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>previewInvoice</b></span>
                        <a href="#previewInvoice"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>previewInvoice(subscription_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, customer_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, price_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1656"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1656</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscription_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>customer_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>price_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="savePaymentMethod"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>savePaymentMethod</b></span>
                        <a href="#savePaymentMethod"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>savePaymentMethod(paymentmethodID: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, userEmail: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="214"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:214</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>paymentmethodID</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>userId</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>userEmail</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveSubscriptionLogs"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>saveSubscriptionLogs</b></span>
                        <a href="#saveSubscriptionLogs"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveSubscriptionLogs(user_label: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, platform: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, resource_name: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, resource_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, webhooks_url: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, request_body: Json, response_body: Json)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1853"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1853</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user_label</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>platform</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>resource_name</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>resource_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>webhooks_url</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>request_body</td>
                                    <td>
                                            <code>Json</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>response_body</td>
                                    <td>
                                            <code>Json</code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="subscribe"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>subscribe</b></span>
                        <a href="#subscribe"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>subscribe(subscribeData: <a href="../classes/SubscribeDto.html" target="_self">SubscribeDto</a>, user: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, auth: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="232"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:232</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscribeData</td>
                                    <td>
                                                <code><a href="../classes/SubscribeDto.html" target="_self" >SubscribeDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>user</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>auth</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateSubscribe"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>updateSubscribe</b></span>
                        <a href="#updateSubscribe"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateSubscribe(subscribeData: <a href="../classes/UpdateCancelEndPeriodSubscribeDto.html" target="_self">UpdateCancelEndPeriodSubscribeDto</a>, cancel_at_period_end: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>, user_id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="363"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:363</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>subscribeData</td>
                                    <td>
                                                <code><a href="../classes/UpdateCancelEndPeriodSubscribeDto.html" target="_self" >UpdateCancelEndPeriodSubscribeDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>cancel_at_period_end</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>user_id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>updateSubscription</b></span>
                        <a href="#updateSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateSubscription(user: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, updateSubscriptionData: <a href="../interfaces/Subscription.html" target="_self">UpdateSubscriptionDto</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1759"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1759</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>updateSubscriptionData</td>
                                    <td>
                                                <code><a href="../interfaces/Subscription.html" target="_self" >UpdateSubscriptionDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="upsertSubscription"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>upsertSubscription</b></span>
                        <a href="#upsertSubscription"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>upsertSubscription(data, user)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="819"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:819</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>data</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="verifyApple"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>verifyApple</b></span>
                        <a href="#verifyApple"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>verifyApple(user, purchaseData)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1115"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1115</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>purchaseData</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="verifyApplePurchase"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>verifyApplePurchase</b></span>
                        <a href="#verifyApplePurchase"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>verifyApplePurchase(user, purchaseData)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="1152"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:1152</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>purchaseData</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="verifyGooglePurchase"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>verifyGooglePurchase</b></span>
                        <a href="#verifyGooglePurchase"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>verifyGooglePurchase(user, purchaseData)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="925"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:925</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>purchaseData</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="verifySub"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>verifySub</b></span>
                        <a href="#verifySub"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>verifySub(user)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="886"
                            class="link-to-prism">src/modules/subscription/subscription.service.ts:886</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>user</td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;Object&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, HttpException, HttpStatus } from &#x27;@nestjs/common&#x27;;
import { InjectRepository } from &#x27;@nestjs/typeorm&#x27;;
import { getConnection, IsNull, Repository } from &#x27;typeorm&#x27;;
import { I18nService } from &#x27;nestjs-i18n&#x27;;
import Verifier from &#x27;google-play-billing-validator&#x27;;
const iap &#x3D; require(&#x27;in-app-purchase&#x27;);

import { userLang } from &#x27;../../helpers/app.helpers&#x27;;
import { StripePaymentMethodEntity } from &#x27;./entities/stripe-payment-method.entity&#x27;;
import {  UsersService } from &#x27;../users/users.service&#x27;
import { Response } from &#x27;../../helpers/response&#x27;;
import { PaymentMethod } from &#x27;./payment-method.interface&#x27;;
import { SubscriptionPlanEntity } from &#x27;./entities/subscription-plan.entity&#x27;;
import { UserPaymentEntity } from &#x27;./entities/user-payment.entity&#x27;;
import { UserSubscriptionEntity } from &#x27;./entities/user-subscription.entity&#x27;;
import * as moment from &#x27;moment-timezone&#x27;;
import { SubscribeDto } from &#x27;./dto/subscribe.dto&#x27;;
import { StripeHelper } from &#x27;../../helpers/stripe.helpers&#x27;;
import { payment_platforms, payment_status, subscription_status, stripe_plan_type, member_type, freeTrialValue, stripe_price_id } from &#x27;../../helpers/util&#x27;;
import { Logger } from &#x27;../../helpers/logger&#x27;;
import { String } from &#x27;aws-sdk/clients/cloudhsm&#x27;;
import { sort_by, google_billing_client, payment_method } from &#x27;../../helpers/util&#x27;;
import { CreateCustomerDto, CreatePaymentMethodDto, CreateSubscriptionDto, UpdateCancelEndPeriodSubscribeDto, UpdateSubscriptionDto } from &#x27;./dto&#x27;;
import { loggers } from &#x27;winston&#x27;;
import { Json } from &#x27;aws-sdk/clients/robomaker&#x27;;
import { SubscriptionLogsEntity } from &#x27;./entities/subscription-logs.entity&#x27;;
import { ExportFile } from &#x27;../../helpers/export-file&#x27;;
import { UserEntity } from &#x27;../users/entities&#x27;;
import GoogleBilling from &quot;../../helpers/google.billing&quot;;
import AppleBilling from &quot;../../helpers/apple.billing&quot;;
import axios from &quot;axios&quot;;

const googleVerifier &#x3D; new Verifier(google_billing_client)

@Injectable()
export class SubscriptionService {

    constructor (
        private readonly i18n: I18nService,
        private readonly response: Response,
        private readonly userService: UsersService,
        private readonly stripe : StripeHelper,
        private readonly exportFile: ExportFile,

        @InjectRepository(SubscriptionPlanEntity)
        private subscriptionPlanMethodRepository : Repository&lt;SubscriptionPlanEntity&gt;,

        @InjectRepository(UserPaymentEntity)
        private userPaymentRepository : Repository&lt;UserPaymentEntity&gt;,

        @InjectRepository(UserSubscriptionEntity)
        private userSubscriptionRepository : Repository&lt;UserSubscriptionEntity&gt;,

        @InjectRepository(SubscriptionLogsEntity)
        private subscriptionLogsRepository : Repository&lt;SubscriptionLogsEntity&gt;,

        @InjectRepository(StripePaymentMethodEntity)
        private stripePaymentMethodRepository : Repository&lt;StripePaymentMethodEntity&gt;,
    ) {}

    async getSubscription(id : string, stripe_id : string) {

        const param &#x3D; id ?? stripe_id
        const column &#x3D; id ? &#x27;subscription_plan._id &#x3D; :param&#x27; : &#x27;subscription_plan.stripe_id &#x3D; :param&#x27;


        const plan &#x3D; await this.subscriptionPlanMethodRepository
        .createQueryBuilder(&#x27;subscription_plan&#x27;)
        .select([
            &#x27;subscription_plan._id as id&#x27;,
            &#x27;subscription_plan.title as title&#x27;,
            &#x27;subscription_plan.ref_code as ref_code&#x27;,
            &#x27;subscription_plan.stripe_id as stripe_id&#x27;,
            &#x27;subscription_plan.subscription_fee as fee&#x27;,
            &#x27;subscription_plan.currency as currency&#x27;,
            &#x27;subscription_plan.subscription_type as type&#x27;,
            &#x27;subscription_plan.description as description&#x27;,
            &#x27;subscription_plan._access as access&#x27;,
        ])
        .where(column, { param })
        .getRawOne();

        if (!plan) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            const error &#x3D; [{ &quot;SubscriptionPlan&quot; : message }];
            Logger.error(&#x60;Failed to getting Subscription Plan : ${param}&#x60;);
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.INTERNAL_SERVER_ERROR
            )
        }
        return plan;
    }

    async getUserSubscription(id : string, order_id : string, payment_id : string) {

        const param &#x3D; await this.getParamsUserSubscription(id, order_id, payment_id)
        const column &#x3D; await this.getColumnUserSubscription(id, order_id, payment_id)

        const data &#x3D; await this.userSubscriptionRepository
        .createQueryBuilder(&#x27;user_subscription&#x27;)
        .select([
            &#x27;user_subscription._id as id&#x27;,
            &#x27;user_subscription._owner_id as owner_id&#x27;,
            &#x27;user_subscription.status as status&#x27;,
            &#x27;user_subscription.startdate as startdate&#x27;,
            &#x27;user_subscription.enddate as enddate&#x27;,
            &#x27;user_subscription.order_id as order_id&#x27;,
            &#x27;user_subscription.payment_id as payment_id&#x27;,
            &#x27;user_subscription.user_label as user_label&#x27;,
            &#x27;user_subscription.extra_enddate as extra_enddate&#x27;,
            &#x27;user_subscription.referral_code as referral_code&#x27;,
            &#x27;user_subscription.is_referral_bonus_claimed as is_referral_bonus_claimed&#x27;
        ])
        .where(column, { param })
        .getRawOne();

        if (!data) {
            const error &#x3D; [{ &quot;UserSubscription&quot; : &#x60;User Subscription data with id ${param} not found &#x60; }];
            Logger.error(&#x60;Failed to get user subscription data : ${param}&#x60;);
            throw new HttpException(await this.response.response(
                await this.i18n.translate(&#x27;message.GENERAL.ERROR.NOT_FOUND&#x27;, { lang: await userLang(null) }),
                null, null), HttpStatus.NOT_FOUND
            )
        }
        return data;
    }

    async getUserPayment(id : string, trancationId : string, originalTransactionId : string){

        const param &#x3D; await this.getParamsUserPayment(id, trancationId, originalTransactionId)
        const column &#x3D; await this.getColumnUserPayment(id, trancationId, originalTransactionId)

        const data &#x3D; await this.userPaymentRepository
        .createQueryBuilder(&#x27;user_payment&#x27;)
        .select([
            &#x27;user_payment._id as id&#x27;,
            &#x27;user_payment._owner_id as user_id&#x27;,
            &#x27;user_payment.subscription_ref_code as ref_code&#x27;,
            &#x27;user_payment.paid_fee as paid_fee&#x27;,
            &#x27;user_payment.status as status&#x27;,
            &#x27;user_payment.currency as currency&#x27;,
            &#x27;user_payment.transaction_id as transaction_id&#x27;,
            &#x27;user_payment.original_transaction_id as original_transaction_id&#x27;,
        ])
        .where(column, { param })
        .getRawOne();

        if (!data) {
            Logger.error(&#x60;UserPayment with id ${param} not found&#x60;);
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.NOT_FOUND&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;UserPayment&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.NOT_FOUND
            )
        }

        return data;
    };


    async getPaidPaymentByUserLabel(user_label: string){
        const data &#x3D; await this.userPaymentRepository
        .createQueryBuilder(&#x27;user_payment&#x27;)
        .select([
            &#x27;user_payment._id as id&#x27;,
            &#x27;user_payment._owner_id as user_id&#x27;,
            &#x27;user_payment.subscription_ref_code as ref_code&#x27;,
            &#x27;user_payment.paid_fee as paid_fee&#x27;,
            &#x27;user_payment.status as status&#x27;,
            &#x27;user_payment.currency as currency&#x27;,
            &#x27;user_payment.transaction_id as transaction_id&#x27;,
            &#x27;user_payment.original_transaction_id as original_transaction_id&#x27;,
        ])
        .where(&#x27;user_payment.user_label &#x3D; :user_label&#x27;, { user_label: user_label })
        .andWhere(&#x27;user_payment.status &#x3D; :status&#x27;, { status: payment_status.PAID })
        .getRawMany();
        return data;

    }

    async getPaymentMethod(userId : string, stripeId : string, authId : string): Promise&lt;PaymentMethod&gt; {

        const param &#x3D; userId ?? stripeId

        const column &#x3D; userId ? &#x27;stripe_paymentmethod.user_id &#x3D; :param&#x27; : &#x27;stripe_paymentmethod.stripe_id &#x3D; :param&#x27;

        const data &#x3D; await this.stripePaymentMethodRepository
        .createQueryBuilder(&#x27;stripe_paymentmethod&#x27;)
        .select([
            &#x27;stripe_paymentmethod.id as id&#x27;,
            &#x27;stripe_paymentmethod.stripe_id as stripe_id&#x27;,
            &#x27;stripe_paymentmethod.user_id as user_id&#x27;,
        ])
        .where(column, { param })
        .getRawOne();

        if (!data) {
            Logger.error(&#x60;Paymentmethod with id ${param} not found&#x60;);
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.NOT_FOUND&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;PaymentMethod&quot; : message }];
            throw new HttpException(await this.response.response(  message, null, error), HttpStatus.NOT_FOUND
            )
        }

        if (data[&#x27;user_id&#x27;] !&#x3D; authId) {
            const message &#x3D;   await this.i18n.translate(&#x27;message.USER.UNAUTHORIZED&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;PaymentMethod&quot; : message }];
            Logger.error(&#x60;PaymentMethod : Payment method data owned by another user, unauthorized&#x60;);
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.UNAUTHORIZED
            )
        }

        return data;
    };

    async savePaymentMethod(paymentmethodID : string, userId : string, userEmail : string) {
        try{
            const payment &#x3D; new StripePaymentMethodEntity()
            payment.user_id &#x3D; userId
            payment.stripe_id &#x3D; paymentmethodID
            payment.email &#x3D; userEmail

            await payment.save();

        } catch (err) {
            Logger.error(&#x60;failed to save payment method, userId: ${userId}, error:${err}&#x60;);
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.SERVER_ERROR&#x27;, { lang: await userLang(null)});
            const error &#x3D; [{ &quot;PaymentMethod&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async subscribe(subscribeData : SubscribeDto, user: any, auth: any): Promise&lt;Object&gt;{


        if(user.member_type &#x3D;&#x3D; member_type.PAID) {
            const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.USER_HAS_ACTIVE_SUBSCRIPTION&#x27;, { lang: await userLang(auth)});
            Logger.error(&#x60;Subscription failed : ${message}&#x60;);
            const error &#x3D; [{ &quot;Subscribe&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
        }

        // if(subscribeData[&#x27;claim_trial&#x27;] &amp;&amp; await this.userService.isFreeTrialClaimed(user.id)) {
        //     const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.FREE_TRIAL_ALREADY_CLAIMED&#x27;, { lang: await userLang(auth)});
        //     Logger.error(&#x60;Claim free trial error : ${message}&#x60;);
        //     const error &#x3D; [{ &quot;ClaimFreeTrial&quot; : message }];
        //     throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
        // }

        if(subscribeData[&#x27;claim_trial&#x27;]) {
            // Bassed on https://atechsolution.atlassian.net/browse/BEDJOE-157
            // Free trial is only for monthly subscription
            if( subscribeData[&#x27;plan_price_id&#x27;] !&#x3D;&#x3D; stripe_price_id.MONTHLY) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.FREE_TRIAL_ONLY_FOR_MONTHLY&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim free trial error : ${message}&#x60;, {data : subscribeData});
                const error &#x3D; [{ &quot;ClaimFreeTrial&quot; : message }];
                throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
            }
            if( await this.userService.isFreeTrialClaimed(user.sub)) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.FREE_TRIAL_ALREADY_CLAIMED&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim free trial error : ${message}&#x60;, {data : subscribeData});
                const error &#x3D; [{ &quot;ClaimFreeTrial&quot; : message }];
                throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
            }
        }


        if(subscribeData[&#x27;referral_code&#x27;]) {
            const existing_payment &#x3D; await this.getPaidPaymentByUserLabel(user.label);

            if(existing_payment.length &gt; 0) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.REFERRAL_ONLY_FOR_NEW_USER&#x27;, { lang: await userLang(auth)});
                Logger.error(&#x60;Claim referral code error : ${message}&#x60;);
                const error &#x3D; [{ &quot;ClaimReferralCode&quot; : message }];
                throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
            }

            if(await this.userService.isReferralCodeClaimed(user.id)) {
                // const message &#x3D; &quot;Referral code has been claimed for this user&quot;
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.REFERRAL_ALREADY_CLAIMED&#x27;, { lang: await userLang(auth)});
                Logger.error(&#x60;Claim referral code error : ${message}&#x60;);
                const error &#x3D; [{ &quot;ClaimReferralCode&quot; : message }];
                throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
            }
            const isReferralCodeValid &#x3D; await this.checkReferralCode(subscribeData[&#x27;referral_code&#x27;]);
            if(!isReferralCodeValid) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.REFERRAL_INVALID&#x27;, { lang: await userLang(auth)});
                Logger.error(&#x60;Claim referral code error : ${message}&#x60;);
                const error &#x3D; [{ &quot;ClaimReferralCode&quot; : message }];
                throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
            }
        }

        const createpayment &#x3D; await this.stripe.createPaymentMethod(subscribeData, user)

        if(!createpayment[&#x27;id&#x27;]) {
            Logger.error(&#x60;Create payment error : ${createpayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data:createpayment});
            const error &#x3D; [{ &quot;PaymentMethod&quot; : &#x60;${createpayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Create payment method failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }
        Logger.info(&#x60;PaymentMethod ${createpayment[&#x27;id&#x27;]} successfully created&#x60;);

        const register_customer &#x3D; await this.stripe.createCustomer(user, createpayment[&#x27;id&#x27;], null)

        if(!register_customer[&#x27;id&#x27;]) {
            Logger.error(&#x60;RegisterStripe : ${register_customer[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data:register_customer});
            const error &#x3D; [{ &quot;RegisterStripe&quot; : &#x60;${register_customer[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Register customer failed&#x27;, null, error), HttpStatus.NOT_FOUND);
        }

        await this.userService.updateStripeId(user, register_customer[&#x27;id&#x27;])
        Logger.info(&#x60;Save stripeId ${register_customer[&#x27;id&#x27;]} to user&#x60;, {user:user, data:register_customer});

        // Attach created payment method to user
        const attach &#x3D; await this.stripe.attachPaymentMethodToUser(createpayment[&#x27;id&#x27;], register_customer[&#x27;id&#x27;]);
        if(!attach[&#x27;id&#x27;]) {
            Logger.error(&#x60;Create attach error : ${attach[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data:attach});
            const error &#x3D; [{ &quot;PaymentMethod&quot; : &#x60;${attach[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Attach payment method failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }

        await this.savePaymentMethod(createpayment[&#x27;id&#x27;], user.id, user.email),
        Logger.info(&#x60;Success save payment method&#x60;, {user:user, data:createpayment});

        // Set created payment method as default on stripe
        const defaultPayment &#x3D; await this.stripe.setDefaultPaymentMethod(register_customer[&#x27;id&#x27;], createpayment[&#x27;id&#x27;])
        if(!defaultPayment[&#x27;id&#x27;]) {
            Logger.error(&#x60;Set default payment method failed: ${defaultPayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data:defaultPayment});
            const error &#x3D; [{ &quot;PaymentMethod&quot; : &#x60;${defaultPayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Attach payment method failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }

        Logger.info(&#x60;Successfully set default payment method ${createpayment[&#x27;id&#x27;]} to ${register_customer[&#x27;id&#x27;]}&#x60;, {user:user, data:createpayment});

        // const add7Days &#x3D; moment().add(7, &#x27;days&#x27;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;);
        const addFreeTrial &#x3D; moment().add(freeTrialValue, &#x27;hours&#x27;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;);
        const trialEnd &#x3D; subscribeData[&#x27;claim_trial&#x27;] ? moment(new Date(addFreeTrial)).format(&#x27;X&#x27;) : null;
        const couponId &#x3D; subscribeData[&#x27;promo_code&#x27;]
        const subscribe &#x3D; await this.stripe.createSubscription(register_customer[&#x27;id&#x27;], subscribeData[&#x27;plan_price_id&#x27;], parseInt(trialEnd))
        if(!subscribe[&#x27;id&#x27;]) {
            Logger.error(&#x60;Proccess subscription : ${subscribe[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data:subscribe});
            const error &#x3D; [{ &quot;ProccessSubscription&quot; : &#x60;${subscribe[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Create subscription failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }
        // If free trial claimed, set claim_referralcode to true
        if (trialEnd !&#x3D; null &amp;&amp; subscribe[&#x27;id&#x27;]) {
            await this.userService.updateFreeTrial(user.id, true)
            Logger.info(&#x60;Free trial claimed on user ${user.id}&#x60;, {user:user});
        }

        this.saveSubscriptionLogs(user.label, payment_platforms.STRIPE, &#x27;create.subscription&#x27;, subscribe[&#x27;id&#x27;], null, JSON.stringify(subscribeData), JSON.stringify(subscribe))

        Logger.info(&#x60;Successfully subscribe with id ${subscribe[&#x27;id&#x27;]}}&#x60;, {user:user, data:subscribe});

        const result &#x3D; await this.getPaymentDataFromSubscribeResponse(subscribe)

        await this.insertSubscriptionData(result, user.id, subscribeData[&#x27;plan_price_id&#x27;], subscribeData[&#x27;referral_code&#x27;])

        return result;

    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async updateSubscribe(subscribeData : UpdateCancelEndPeriodSubscribeDto, cancel_at_period_end : boolean, user_id : string) : Promise&lt;Object&gt;{

        const data &#x3D; await this.getUserSubscription(null,subscribeData[&#x27;subscription_id&#x27;], null)
        const user &#x3D; await this.userService.getUser(user_id, null).getRawOne()

        if(data[&#x27;user_label&#x27;] !&#x3D; user[&#x27;label&#x27;]) {
            Logger.error(&#x60;UpdateSubscription : Subcription data owned by another user, unauthorized&#x60;);
            const message &#x3D;   await this.i18n.translate(&#x27;message.USER.UNAUTHORIZED&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;UpdateSubscription&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.UNAUTHORIZED);
        }

        const unsubscribe &#x3D; await this.stripe.updateSubscription(subscribeData[&#x27;subscription_id&#x27;], cancel_at_period_end, null, null);
    
        if(!unsubscribe[&#x27;id&#x27;]) {
            Logger.error(&#x60;UpdateSubscription: ${unsubscribe[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;UpdateSubscription&quot; : &#x60;${unsubscribe[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Update subscription failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }
        return unsubscribe;
    }

    async insertSubscriptionData(data, userId, subscription_ref_code, referral_code) {
        const user &#x3D; await this.userService.getUser(userId, null)
        .getRawOne();

        const queryRunner &#x3D; getConnection().createQueryRunner();

        await queryRunner.connect();

        await queryRunner.startTransaction();

        try{
            const payment &#x3D; new UserPaymentEntity()
            payment._database_id &#x3D; &quot;&quot;
            payment._owner_id &#x3D; userId
            payment._access &#x3D; &#x27;[{&quot;level&quot;: &quot;read&quot;, &quot;public&quot;: true}]&#x27;
            payment._created_by &#x3D; userId
            payment._updated_by &#x3D; userId
            payment.subscription_ref_code &#x3D; subscription_ref_code;
            payment.paid_fee &#x3D; data.paid_fee / 100
            payment.status &#x3D; payment_status.UNPAID;
            payment.currency &#x3D; data.currency.toUpperCase()
            payment.payment_method &#x3D; payment_platforms.STRIPE
            payment.user_label &#x3D; user[&#x27;label&#x27;]
            payment.original_transaction_id &#x3D; data.subsription_id
            payment.transaction_id &#x3D; await this.getTrancationIdFromSubscriptionResult(data)
            payment.remarks &#x3D; null
            await queryRunner.manager.save(payment);

            const subscription &#x3D; new UserSubscriptionEntity()
            subscription._database_id &#x3D; &quot;&quot;
            subscription._owner_id &#x3D; userId
            subscription._access &#x3D; &#x27;[{&quot;level&quot;: &quot;read&quot;, &quot;public&quot;: true}]&#x27;
            subscription._created_by &#x3D; userId
            subscription._updated_by &#x3D; userId
            subscription.startdate &#x3D; new Date(moment.unix(data.start_date).tz(&#x27;Hongkong&#x27;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;))
            subscription.enddate &#x3D; new Date(moment.unix(data.end_date).tz(&#x27;Hongkong&#x27;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;))
            subscription.subscription_ref_code &#x3D; subscription_ref_code;
            subscription.original_fee &#x3D; data.paid_fee / 100
            subscription.currency &#x3D; data.currency.toUpperCase()
            subscription.user_label &#x3D; user[&#x27;label&#x27;]
            subscription.order_id &#x3D; data.subsription_id
            subscription.payment_id &#x3D; await this.getTrancationIdFromSubscriptionResult(data)
            subscription.purchase_token &#x3D; &quot;&quot;
            subscription.status &#x3D; subscription_status.INACTIVE
            subscription.referral_code &#x3D; referral_code
            await queryRunner.manager.save(subscription);

            await queryRunner.commitTransaction();
        } catch (err) {
            await queryRunner.rollbackTransaction();
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_CREATE&#x27;, { lang: await userLang(user) });
            const error &#x3D; [{ &quot;Subscription&quot; : message }];
            Logger.error(err, {data, userId, subscription_ref_code});
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.INTERNAL_SERVER_ERROR)
        }

        finally {
            // release query runner
            await queryRunner.release();
        }
    }

    async getTrancationIdFromSubscriptionResult(data : any) : Promise&lt;string&gt; {
        return data.payment_intent_id ?? data.invoice_id
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async checkReferralCode(couponId : string): Promise&lt;any&gt; {
        const user &#x3D; await this.userService.getUserByReferralCode(couponId)
        return user ? true : false;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async getMonthlyPlanProductId() : Promise&lt;String&gt; {
        const type_plan &#x3D; stripe_plan_type.MONTHLY;
        const plan &#x3D; await this.subscriptionPlanMethodRepository
        .createQueryBuilder(&#x27;subscription_plan&#x27;)
        .select([
            &#x27;subscription_plan.stripe_id as stripe_id&#x27;,
        ])
        .where(&#x27;subscription_plan.subscription_type &#x3D; :type_plan&#x27;, {type_plan})
        .getRawOne();

        if (!plan) {
            Logger.error(&#x60;Data not found&#x60;);
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.NOT_FOUND&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;Subscription&quot; : message }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.NOT_FOUND);
        }

        return plan[&#x27;stripe_id&#x27;];
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async getPaymentDataFromSubscribeResponse(data : any) : Promise&lt;Object&gt; {
        return {
            subsription_id: data[&#x27;id&#x27;],
            invoice_id: data[&#x27;latest_invoice&#x27;][&#x27;id&#x27;],
            status: data[&#x27;latest_invoice&#x27;][&#x27;payment_intent&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;payment_intent&#x27;][&#x27;status&#x27;] : null,
            paid_fee: data[&#x27;latest_invoice&#x27;][&#x27;amount_due&#x27;],
            currency: data[&#x27;latest_invoice&#x27;][&#x27;currency&#x27;],
            invoice_url: data[&#x27;latest_invoice&#x27;][&#x27;hosted_invoice_url&#x27;],
            payment_intent_id: data[&#x27;latest_invoice&#x27;][&#x27;payment_intent&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;payment_intent&#x27;][&#x27;id&#x27;] : null,
            client_secret: data[&#x27;latest_invoice&#x27;][&#x27;payment_intent&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;payment_intent&#x27;][&#x27;client_secret&#x27;] : null,
            start_date: data[&#x27;current_period_start&#x27;],
            end_date: data[&#x27;current_period_end&#x27;],
            discount_id: data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;][&#x27;id&#x27;] : null,
            coupon_id: data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;][&#x27;coupon&#x27;][&#x27;id&#x27;] : null,
            discount_percent: data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;][&#x27;coupon&#x27;][&#x27;percent_off&#x27;] : null,
            coupon_validity_status: data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;] ? data[&#x27;latest_invoice&#x27;][&#x27;discount&#x27;][&#x27;coupon&#x27;][&#x27;valid&#x27;] : null,
        };
    }


    async getSubscriptionPlan(query): Promise&lt;Object&gt; {

        const skippedItems:number &#x3D; (query.page - 1) * query.size;

        const subscription &#x3D; this.subscriptionPlanMethodRepository
        .createQueryBuilder(&#x27;subscriptionPlan&#x27;)
        .select([
            &#x27;subscriptionPlan.description as description&#x27;,
            &#x27;subscriptionPlan.title as title&#x27;,
            &#x27;subscriptionPlan.sequence as sequence&#x27;,
            &#x27;subscriptionPlan.price_tag as price_tag&#x27;,
            &#x27;subscriptionPlan.subscription_fee as subscription_fee&#x27;,
            &#x27;subscriptionPlan.currency as currency&#x27;,
            &#x27;subscriptionPlan.badge as badge&#x27;,
            &#x60;json_agg(DISTINCT jsonb_build_object
                (&#x27;subscription_type&#x27;, subscriptionPlan.subscription_type,
                &#x27;id&#x27;, subscriptionPlan._id, &#x27;ref_code&#x27;,
                subscriptionPlan.ref_code)) AS platform&#x60;,
        ])
        .groupBy(&#x60;
                subscriptionPlan.description,
                subscriptionPlan.title,
                subscriptionPlan.sequence,
                subscriptionPlan.price_tag,
                subscriptionPlan.subscription_fee,
                subscriptionPlan.currency,
                subscriptionPlan.badge
                &#x60;)
        .orderBy(&#x27;subscriptionPlan.sequence&#x27;, query.sort_sequence &#x3D;&#x3D;&#x3D; sort_by.DESC ? sort_by.DESC : sort_by.ASC)

        let subscriptions &#x3D; []

        try{
            if(query.size) {
                subscriptions &#x3D; await subscription
                .offset(skippedItems)
                .limit(query.size)
                .getRawMany()
            } else {
                subscriptions &#x3D; await subscription.getRawMany()
            }

            const subs &#x3D; subscriptions.map(async (el)&#x3D;&gt;{
                Promise.all(el.platform.map((platform)&#x3D;&gt;{
                    const type &#x3D; platform.subscription_type.split(&#x27;_&#x27;)
                    if( type[0] &#x3D;&#x3D;&#x3D; payment_platforms.GOOGLE ) el.android &#x3D; platform
                    if( type[0] &#x3D;&#x3D;&#x3D; payment_platforms.APPLE ) el.ios &#x3D; platform
                    if( type[0] &#x3D;&#x3D;&#x3D; payment_platforms.STRIPE ) el.stripe &#x3D; platform
                }));
                delete el.platform;
                return el;
            })

            return await Promise.all(subs)
        }catch(err){
            Logger.error(&#x60;failed to get subscription plans&#x60;, {error : err, data : query})
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            const error &#x3D; [{ &quot;SubscriptionPlan&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.INTERNAL_SERVER_ERROR)
        }
    }

    async getParamsUserSubscription(id : string, order_id : string, payment_id : string) : Promise&lt;string&gt; {
        switch (true) {
            case id !&#x3D; null : {
                return id
            }
            case order_id !&#x3D; null : {
                return order_id
            }
            case payment_id !&#x3D; null : {
                return payment_id
            }
            default:
        }
    }

    async getColumnUserSubscription(id : string, order_id : string, payment_id : string) : Promise&lt;string&gt; {

        switch (true) {
            case id !&#x3D; null: {
                return &#x27;user_subscription._id &#x3D; :param&#x27;
              }
            case order_id !&#x3D; null: {
                return &#x27;user_subscription.order_id &#x3D; :param&#x27;
            }
            case payment_id !&#x3D; null: {
                return &#x27;user_subscription.payment_id &#x3D; :param&#x27;
            }
            default:
        }
    }

    async getParamsUserPayment(id : string, transaction_id : string, original_transaction_id : string) : Promise&lt;string&gt; {
        switch (true) {
            case id !&#x3D; null : {
                return id
            }
            case transaction_id !&#x3D; null : {
                return transaction_id
            }
            case original_transaction_id !&#x3D; null : {
                return original_transaction_id
            }
            default:
        }
    }

    async getColumnUserPayment(id : string, transaction_id : string, original_transaction_id : string) : Promise&lt;string&gt; {
        switch (true) {
            case id !&#x3D; null: {
                return &#x27;user_payment._id &#x3D; :param&#x27;
              }
            case transaction_id !&#x3D; null: {
                return &#x27;user_payment.transaction_id &#x3D; :param&#x27;
            }
            case original_transaction_id !&#x3D; null: {
                return &#x27;user_payment.original_transaction_id &#x3D; :param&#x27;
            }
            default:
        }
    }

    async getAllUserSub(userData){
        const user &#x3D; await this.userService.getUser(userData.sub ?? userData[&#x27;_id&#x27;], null)
        .getRawOne();
        const userLabel &#x3D; user[&#x27;label&#x27;]

        const sub &#x3D; await this.userSubscriptionRepository
            .createQueryBuilder(&#x27;sub&#x27;)
            .select([
                &#x27;sub._id as id&#x27;,
                &#x27;sub.user_label as user_label&#x27;,
                &#x27;sub.startdate as start_date&#x27;,
                &#x27;sub.enddate as end_date&#x27;,
                &#x27;sub.extra_enddate as extra_enddate&#x27;,
                &#x27;sub.subscription_ref_code&#x27;,
                &#x27;sub.status as status&#x27;,
                &#x27;sub.purchase_token as purchase_token&#x27;,
                &#x27;sub.order_id as subscription_id&#x27;,
                &#x27;sub._created_at as created_at&#x27;,
                &#x27;plan.subscription_type as subscription_type&#x27;,
                &#x27;plan.title as title&#x27;,
                &#x27;plan.price_tag as price_tag&#x27;,
                &#x27;plan.subscription_fee as subsription_fee&#x27;,
                &#x27;plan.currency as currency&#x27;
            ])
            .leftJoin(SubscriptionPlanEntity, &#x27;plan&#x27;, &#x27;sub.subscription_ref_code &#x3D; plan.ref_code&#x27;)
            .where(&#x27;sub.user_label &#x3D; :label&#x27;, { label: userLabel })
            .orderBy(&#x27;sub._updated_at&#x27;, &#x27;DESC&#x27;)
            .getRawOne();

        if (sub) {
            const stripe &#x3D; await this.stripe.getSubscription(sub.subscription_id)
            if(stripe[&#x27;id&#x27;]) {
                sub[&#x27;cancel_at_period_end&#x27;] &#x3D; stripe[&#x27;cancel_at_period_end&#x27;]
            }
            return sub;
        } else {
            return null;
        }
    }

    async getUserSub(userData){
        const user &#x3D; await this.userService.getUser(userData.sub ?? userData[&#x27;_id&#x27;], null)
        .getRawOne();
        const userLabel &#x3D; user[&#x27;label&#x27;]

        const sub &#x3D; await this.userSubscriptionRepository
            .createQueryBuilder(&#x27;sub&#x27;)
            .select([
                &#x27;sub._id as id&#x27;,
                &#x27;sub.user_label as user_label&#x27;,
                &#x27;sub.startdate as start_date&#x27;,
                &#x27;sub.enddate as end_date&#x27;,
                &#x27;sub.extra_enddate as extra_enddate&#x27;,
                &#x27;sub.subscription_ref_code&#x27;,
                &#x27;sub.status as status&#x27;,
                &#x27;sub.order_id as subscription_id&#x27;,
                &#x27;sub._created_at as created_at&#x27;,
                &#x27;plan.subscription_type as subscription_type&#x27;,
                &#x27;plan.title as title&#x27;,
                &#x27;plan.price_tag as price_tag&#x27;,
                &#x27;plan.subscription_fee as subsription_fee&#x27;,
                &#x27;plan.currency as currency&#x27;
            ])
            .leftJoin(SubscriptionPlanEntity, &#x27;plan&#x27;, &#x27;sub.subscription_ref_code &#x3D; plan.ref_code&#x27;)
            .where(&#x27;sub.user_label &#x3D; :label&#x27;, { label: userLabel })
            .andWhere(&#x27;sub.status &#x3D; :status&#x27;, { status: subscription_status.ACTIVE})
            .orderBy(&#x27;sub._created_at&#x27;, &#x27;DESC&#x27;)
            .getRawOne();

        if (sub) {
            const stripe &#x3D; await this.stripe.getSubscription(sub.subscription_id)
            if(stripe[&#x27;id&#x27;]) {
                sub[&#x27;cancel_at_period_end&#x27;] &#x3D; stripe[&#x27;cancel_at_period_end&#x27;]
            }
            return sub;
        } else {
            return null;
        }
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async getSubscriptionStatus(subscription_id : string) : Promise&lt;Object&gt; {

        if(!subscription_id) {
            Logger.error(&#x60;subscription_id cannot be empty&#x60;);
            const error &#x3D; [{ &quot;GetSetupIntent&quot; : &#x60;subscription_id cannot be empty&#x60; }];
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }

        const subs &#x3D; await this.stripe.getSubscription(subscription_id);

        if(!subs[&#x27;id&#x27;]) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_CREATE&#x27;, { lang: await userLang(null) });
            Logger.error(&#x60;RetrieveSubscription: ${subs[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;RetrieveSubscription&quot; : subs[&#x27;raw&#x27;][&#x27;message&#x27;] }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }

        return subs;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async getSubscriptionByUserLabel(user_label:string): Promise&lt;Object&gt;{
        const subs &#x3D; await this.userSubscriptionRepository
        .createQueryBuilder(&#x27;sub&#x27;)
        .select([
            &#x27;sub._id as id&#x27;,
            &#x27;sub.user_label as user_label&#x27;,
            &#x27;sub.status as status&#x27;,
            &#x27;sub.startdate as startdate&#x27;,
            &#x27;sub.enddate as enddate&#x27;,
            &#x27;sub.order_id as order_id&#x27;,
            &#x27;sub.subscription_ref_code as ref_code&#x27;,
            &#x27;sub.purchase_token as purchase_token&#x27;
        ])
        .where(&#x27;sub.user_label &#x3D; :user_label&#x27;, { user_label: user_label})
        .andWhere(&#x27;sub.status &#x3D; :status&#x27;, { status: subscription_status.ACTIVE})
        .getRawMany();

        return subs ?? null;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async getUserSubscriptionByOrderId(order_id:string, user_label:string): Promise&lt;Object&gt;{
        const subs &#x3D; await this.userSubscriptionRepository
        .createQueryBuilder(&#x27;sub&#x27;)
        .select([
            &#x27;sub._id as id&#x27;,
            &#x27;sub.user_label as user_label&#x27;,
            &#x27;sub.status as status&#x27;,
            &#x27;sub.startdate as startdate&#x27;,
            &#x27;sub.enddate as enddate&#x27;,
            &#x27;sub.order_id as order_id&#x27;,
            &#x27;sub.subscription_ref_code as ref_code&#x27;,
            &#x27;sub.purchase_token as purchase_token&#x27;
        ])
        .where(&#x27;sub.user_label &#x3D; :user_label&#x27;, { user_label: user_label})
        .andWhere(&#x27;sub.order_id &#x3D; :order_id&#x27;, { order_id: order_id})
        .getRawOne();

        return subs ?? null;
    }


    async inactiveSubscription(subcription_id : string) {
        try {
            await this.userSubscriptionRepository.update({ order_id: subcription_id }, { status : subscription_status.INACTIVE, _updated_at : moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;)});
            Logger.info(&#x60;Successfully inactive subscription with order_id ${subcription_id}&#x60;);
        } catch(error){
            Logger.error( &#x60;Failed inactive subscription with order_id ${subcription_id}&#x60;, {error :error});
        }
    }

    async getSubPLan(reffCode, currency &#x3D; &#x27;HKD&#x27;): Promise&lt;object&gt;{
        // fix currency

        return await this.subscriptionPlanMethodRepository
        .createQueryBuilder(&#x27;sub&#x27;)
        .select([
            &#x27;sub.subscription_fee as subscription_fee&#x27;,
            &#x27;sub.currency as currency&#x27;
        ])
        .where(&#x27;sub.ref_code &#x3D; :refcode&#x27;, { refcode: reffCode })
        .andWhere(&#x27;sub.currency &#x3D; :currency&#x27;, { currency })
        .getRawOne();
    }

    async insertUserPayment(data, user): Promise&lt;void&gt;{

            const queryBuilder &#x3D; getConnection().createQueryBuilder();
            const payment &#x3D; {
                _database_id : &quot;&quot;,
                _owner_id : user.sub,
                _access : &#x27;[{&quot;level&quot;: &quot;read&quot;, &quot;public&quot;: true}]&#x27;,
                _created_by : user.sub,
                _updated_by : user.sub,
                subscription_ref_code : data.subscription_ref_code,
                paid_fee : data.paid_fee,
                status : data.status,
                currency : data.currency,
                info : data.payment_info || null,
                payment_method : data.payment_method,
                user_label : user[&#x27;label&#x27;],
                original_transaction_id : data.original_transaction_id,
                transaction_id : data.transaction_id,
                _created_at : moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;),
                _updated_at : moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;)
            }

            await queryBuilder.insert().into(UserPaymentEntity)
            .values(payment)
            .onConflict(&#x60;DO NOTHING&#x60;).execute();
            Logger.info(&#x60;Success insert user_payment ${ data.transaction_id}&#x60;);
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async upsertSubscription(data, user): Promise&lt;void&gt;{

        const queryBuilder &#x3D; getConnection().createQueryBuilder();

        const subscriptionData &#x3D; {
            _updated_by: user.sub,
            _created_by: user.sub,
            _owner_id: user.sub,
            _created_at: moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;),
            _updated_at: moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;),
            _database_id : &#x27;&#x27;,
            user_label: user[&#x27;label&#x27;],
            startdate: data[&#x27;start_date&#x27;],
            enddate: data[&#x27;end_date&#x27;],
            subscription_ref_code : data[&#x27;subscription_ref_code&#x27;],
            original_fee: data[&#x27;original_fee&#x27;],
            currency: data[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
            order_id:  data[&#x27;order_id&#x27;],
            purchase_token: data[&#x27;purchase_token&#x27;],
            status: data[&#x27;status&#x27;],
        }

        const currentSubscription &#x3D; await this.getUserSubscriptionByOrderId(data[&#x27;order_id&#x27;], user[&#x27;label&#x27;]);

        // If current subscription longer than purchased enddate no need to update
        if(currentSubscription &amp;&amp;  moment(data[&#x27;end_date&#x27;]).isBefore(moment(currentSubscription[&#x27;enddate&#x27;]) )){
            data[&#x27;end_date&#x27;] &#x3D; currentSubscription[&#x27;enddate&#x27;];
        }

        await queryBuilder.insert().into(UserSubscriptionEntity)
            .values(subscriptionData)
            .onConflict(
                &#x60;(user_label, order_id)
                DO UPDATE SET &quot;status&quot; &#x3D; :status,
                &quot;purchase_token&quot; &#x3D; :token,
                &quot;startdate&quot; &#x3D; :startdate,
                &quot;enddate&quot; &#x3D; :enddate&#x60;)
            .setParameters({
                &quot;status&quot;: data[&#x27;status&#x27;],
                &quot;token&quot;: data[&#x27;purchase_token&#x27;],
                &quot;startdate&quot; : data[&#x27;start_date&#x27;],
                &quot;enddate&quot; : data[&#x27;end_date&#x27;]
            })
            .execute();
    }

    async lastPayment(user) {
        return await this.userPaymentRepository
            .createQueryBuilder(&#x27;payment&#x27;)
            .select([
                &#x27;payment_method&#x27;,
            ])
            .where(&#x27;payment.user_label &#x3D; :label&#x27;, { label: user.label })
            .limit(1)
            .orderBy(&#x27;_created_at&#x27;, &#x27;DESC&#x27;)
            .getRawOne();
    }

    async checkIfRecordExpired(user) {
        const userInfo &#x3D; await this.getSubscriptionByUserLabel(user[&#x27;label&#x27;]);
        if(userInfo) {
            return userInfo[&#x27;enddate&#x27;] &lt;&#x3D; moment().format() ? true : false;
        }else{
            return false
        }
    }

    async verifySub(user) : Promise&lt;Object&gt; {
        const userLabel &#x3D; user[&#x27;label&#x27;];
        const currency &#x3D; &#x27;HKD&#x27;;
        const latestUserSubscriptions &#x3D; await this.getAllUserSub(user);
        const currentUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                    .getRawOne();
        let lastLoginData &#x3D; currentUser[&#x27;last_login_at&#x27;];
        let todayStart &#x3D; new Date(moment().startOf(&#x27;day&#x27;).format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;));
        if(lastLoginData &lt; todayStart){
            let userLastLogin: any &#x3D; {last_login_at: moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;)};
            await this.userService.updateUser(userLastLogin, user);
        }

        if (latestUserSubscriptions &amp;&amp; latestUserSubscriptions.end_date &gt; new Date()) {
            await this.userService.updateMemberType(user.sub, member_type.PAID);
            const afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                    .getRawOne();
            return {
                member_type : afterUser[&#x27;member_type&#x27;],
                validity: true,
                lastReceipt: {},
                latestSubscription: latestUserSubscriptions
            }
        }

        if (latestUserSubscriptions &amp;&amp; latestUserSubscriptions.end_date &lt;&#x3D; new Date()){
             const cross_payment &#x3D; this.crossPlatformSubsCheck(user, latestUserSubscriptions, currency);
             return cross_payment;
        }

        const exp &#x3D; await this.checkIfRecordExpired(user)
        return {
            member_type : currentUser[&#x27;member_type&#x27;],
            validity: exp,
            lastReceipt: {},
            latestSubscription: {},
        }
    }

    async verifyGooglePurchase(user, purchaseData): Promise&lt;any&gt;{
        const activeSubscription &#x3D; await this.getUserSub(user);

        const latestUserSubscriptions &#x3D; await this.getAllUserSub(user);

        const currentUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                            .getRawOne();
        const userLabel &#x3D; user[&#x27;label&#x27;];

        let googleSubscriptionId;
        let googleProductId;
        let googleProductToken;
        let receiptData;
        let currentToken;
        let afterUser;

        const currency &#x3D; &#x27;HKD&#x27;;

        try{
            if (purchaseData.receipt !&#x3D;&#x3D; &quot;&quot;) {
                if (latestUserSubscriptions &amp;&amp; latestUserSubscriptions.end_date &gt; new Date()) {
                    await this.userService.updateMemberType(user.sub, member_type.PAID);
                    afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                            .getRawOne();
                    return {
                        member_type : afterUser[&#x27;member_type&#x27;],
                        validity: true,
                        lastReceipt: {},
                        latestSubscription: latestUserSubscriptions
                    }
                }            
                receiptData &#x3D; JSON.parse(purchaseData[&#x27;receipt&#x27;]);
                const userReceipt &#x3D; {
                    ...receiptData,
                    developerPayload: &#x27;ddr-google-billing-verification&#x27;
                };

                googleSubscriptionId &#x3D; receiptData[&#x27;orderId&#x27;];
                googleProductId &#x3D; receiptData[&#x27;productId&#x27;];
                googleProductToken &#x3D; receiptData[&#x27;purchaseToken&#x27;];

                // if there is an other user receipt
                const getSameSubs &#x3D; await this.userSubscriptionRepository
                        .createQueryBuilder(&#x27;sub&#x27;)
                        .select([&#x27;sub.user_label as user_label&#x27;])
                        .where(&#x27;sub.order_id &#x3D; :order_id&#x27;, { order_id: receiptData[&#x27;orderId&#x27;] })
                        .orderBy(&#x27;_created_at&#x27;, &#x27;DESC&#x27;)
                        .getRawOne();
                if (getSameSubs &amp;&amp; getSameSubs.user_label !&#x3D;&#x3D; userLabel) {
                    if (latestUserSubscriptions &amp;&amp; latestUserSubscriptions.end_date &lt;&#x3D; new Date()){
                         const cross_payment &#x3D; this.crossPlatformSubsCheck(user, latestUserSubscriptions, currency);
                         return cross_payment;
                    }
                    return {
                        member_type : currentUser[&#x27;member_type&#x27;],
                        validity: false,
                        lastReceipt: {},
                        latestSubscription: latestUserSubscriptions
                    }        
                }
            }

            if (purchaseData.receipt &#x3D;&#x3D; &quot;&quot; &amp;&amp; latestUserSubscriptions) {
                if (latestUserSubscriptions.end_date &gt; new Date()) {
                    await this.userService.updateMemberType(user.sub, member_type.PAID);
                    afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                                .getRawOne();
                    return {
                        member_type : afterUser[&#x27;member_type&#x27;],
                        validity : true,
                        lastReceipt: {},
                        latestSubscription: latestUserSubscriptions
                    }
                }

                if (latestUserSubscriptions.end_date &lt;&#x3D; new Date()) {
                    const getUserSubscriptionLog &#x3D; await this.subscriptionLogsRepository
                        .createQueryBuilder(&#x27;sublogs&#x27;)
                        .select([&#x27;sublogs.request_body as request_body&#x27;])
                        .where(&#x27;sublogs.user_label &#x3D; :label&#x27;, { label: userLabel })
                        .orderBy(&#x27;sublogs.created_at&#x27;, &#x27;DESC&#x27;)
                        .getRawOne();

                    currentToken &#x3D; JSON.parse(getUserSubscriptionLog.request_body.receipt);
                    const sendToken &#x3D; currentToken[&#x27;purchaseToken&#x27;];
                    
                    googleSubscriptionId &#x3D; latestUserSubscriptions.subscription_id;
                    googleProductId &#x3D; latestUserSubscriptions.sub_subscription_ref_code;
                    googleProductToken &#x3D; sendToken;
                }
            }

            if(purchaseData.receipt &#x3D;&#x3D; &quot;&quot; &amp;&amp; !latestUserSubscriptions) {
                await this.userService.updateMemberType(user.sub, member_type.FREE);
                afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                                .getRawOne();
                return {
                    member_type : afterUser[&#x27;member_type&#x27;],
                    validity: false,
                    lastReceipt: {},
                    latestSubscription: {}
                }
            }

            const data &#x3D; await GoogleBilling.getsubscriptionDetail(googleProductId, googleProductToken);
            // handling purchase data was dissapear from google
            if(data.code &#x3D;&#x3D; 410){
                await this.userService.updateMemberType(user.sub, member_type.FREE);
                afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                                .getRawOne();
                return {
                    member_type : afterUser[&#x27;member_type&#x27;],
                    validity: false,
                    lastReceipt: {},
                    latestSubscription: {}
                }
            }

            if (purchaseData.receipt !&#x3D;&#x3D;  &quot;&quot;) {
                this.saveSubscriptionLogs(user.label, payment_platforms.GOOGLE, &#x27;verify.subscription&#x27;, receiptData[&#x27;orderId&#x27;], null, JSON.stringify(purchaseData), JSON.stringify(data));
            }

            Logger.info(&#x27;verify google purchase&#x27;,{user, data});

            if (data.acknowledgementState &#x3D;&#x3D; 0) {
                throw new Error(&#x27;Subscription not acknowledge&#x27;);
            }

            const startDate &#x3D; moment(parseInt(data.startTimeMillis)).format();
            const dateExpiry &#x3D; moment(parseInt(data.expiryTimeMillis)).format();
            const subPlan &#x3D; await this.getSubPLan(googleProductId);
            const subscriptionStatus &#x3D; !!data.userCancellationTimeMillis ? subscription_status.INACTIVE : subscription_status.ACTIVE;

            const subData &#x3D; {
                start_date: startDate,
                end_date: dateExpiry,
                subscription_ref_code: googleProductId,
                order_id: googleSubscriptionId,
                purchase_token: (purchaseData.receipt !&#x3D;&#x3D; &quot;&quot;) ? purchaseData[&#x27;receipt&#x27;] : JSON.stringify(currentToken),
                status: subscriptionStatus,
                original_fee: subPlan[&#x27;subscription_fee&#x27;],
            }

            const paymentData &#x3D; {
                subscription_ref_code : googleSubscriptionId,
                paid_fee: subPlan[&#x27;subscription_fee&#x27;],
                status : payment_status.PAID,
                currency : subPlan[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
                payment_method : payment_method.GOOGLE,
                payment_info : (purchaseData.receipt !&#x3D;&#x3D; &quot;&quot;) ? purchaseData[&#x27;receipt&#x27;] : JSON.stringify(currentToken)
            }

            if( dateExpiry &lt;&#x3D; moment().format() ) {
                subData.status &#x3D; subscription_status.INACTIVE;
                await this.userService.updateMemberType(user.sub, member_type.FREE);
            } else {
                await this.userService.updateMemberType(user.sub, member_type.PAID);
            }

            await this.upsertSubscription(subData, user);
            await this.insertUserPayment(paymentData, user);

            // If member claim free trial on this subscription update member status claim trial
            if(data &amp;&amp; data.paymentState &#x3D;&#x3D; 2) {
                await this.userService.updateFreeTrial(user.sub, true);
            }

            afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                                .getRawOne();
            return {
                member_type : afterUser[&#x27;member_type&#x27;],
                validity : dateExpiry &gt;&#x3D; moment().format() || activeSubscription ? true : false,
                lastReceipt: data,
                latestSubscription: latestUserSubscriptions
            }

        } catch(err) {
            // if(!err.isSuccessful) {
            //     await this.userService.updateMemberType(user.sub, member_type.FREE)
            // }
            const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.VERIFY_GOOGLE_FAILED&#x27;, { lang: await userLang(user) })
            Logger.error(message, { user: user, error : err });
            if (purchaseData.receipt !&#x3D;&#x3D; &quot;&quot;) {
                this.saveSubscriptionLogs(user.label, payment_platforms.GOOGLE, &#x27;verify.subscription&#x27;, receiptData[&#x27;orderId&#x27;], null, JSON.stringify(purchaseData), err)
            }
            const error &#x3D; [{ &quot;subscription&quot; : message }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.NOT_FOUND);
        }
    }

    async verifyApple(user, purchaseData): Promise&lt;any&gt; {

        const region &#x3D; purchaseData.region || &#x27;HK&#x27;;
        const applePassword &#x3D; region &#x3D;&#x3D; &#x27;TW&#x27; ? process.env.APPLE_TW_BILLING_SECRET : process.env.APPLE_BILLING_SECRET;
        const sandbox_url &#x3D; &#x27;https://sandbox.itunes.apple.com/verifyReceipt&#x27;;
        const ios_url &#x3D; &#x27;https://buy.itunes.apple.com/verifyReceipt&#x27;;

        try {

            let form_field &#x3D; {
                &#x27;receipt-data&#x27;: purchaseData.receipt,
                &#x27;password&#x27;: applePassword,
                &#x27;exclude-old-transactions&#x27;: true
            };

            let checkdata &#x3D; await axios.post(ios_url, form_field, {
                headers: {
                    &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
                }
            });

            if( checkdata.data.status &#x3D;&#x3D; 21007 ) {
                checkdata &#x3D; await axios.post(sandbox_url, form_field, {
                    headers: {
                        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
                    }
                });
            }

            return checkdata.data.latest_receipt_info[0];
        
        } catch(error) {
            Logger.info(&#x27;invalid verify purchase apple&#x27;, { error : error, user : user, data : purchaseData, region });
        };

    }

    async verifyApplePurchase(user, purchaseData):Promise&lt;any&gt;{
        const activeSubscription &#x3D; await this.getUserSub(user);
        const latestUserSubscriptions &#x3D; await this.getAllUserSub(user);
        const currentUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                            .getRawOne();
        const userLabel &#x3D; user[&#x27;label&#x27;];

        let receiptData;
        let purchaseDate;
        let expiryDate;
        let appleProductId;
        let appleOriginalTransactionId;
        let appleTransactionId;
        let applePurchaseToken;
        let afterUser;

        const currency &#x3D; purchaseData.region &#x3D;&#x3D; &#x27;TW&#x27; ? &#x27;TWD&#x27; : &#x27;HKD&#x27;;

        try{
            if (purchaseData.receipt !&#x3D;&#x3D; &quot;&quot;) {
                if (latestUserSubscriptions &amp;&amp; latestUserSubscriptions.end_date &gt; new Date()) {
                    await this.userService.updateMemberType(user.sub, member_type.PAID);
                    afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                            .getRawOne();
                    return {
                        member_type : afterUser[&#x27;member_type&#x27;],
                        validity: true,
                        lastReceipt: {},
                        latestSubscription: latestUserSubscriptions
                    }
                }

                receiptData &#x3D; await this.verifyApple(user, purchaseData);

                purchaseDate &#x3D; receiptData[&#x27;purchase_date_ms&#x27;];
                expiryDate &#x3D; receiptData[&#x27;expires_date_ms&#x27;];
                appleProductId &#x3D; receiptData[&#x27;product_id&#x27;];
                appleOriginalTransactionId &#x3D;  receiptData[&#x27;original_transaction_id&#x27;]; 
                appleTransactionId &#x3D; receiptData[&#x27;transaction_id&#x27;];
                applePurchaseToken &#x3D; purchaseData.receipt;

                // if there is an other user receipt
                const getSameSubs &#x3D; await this.userSubscriptionRepository
                        .createQueryBuilder(&#x27;sub&#x27;)
                        .select([&#x27;sub.user_label as user_label&#x27;])
                        .where(&#x27;sub.order_id &#x3D; :order_id&#x27;, { order_id: receiptData[&#x27;original_transaction_id&#x27;] })
                        .orderBy(&#x27;_created_at&#x27;, &#x27;DESC&#x27;)
                        .getRawOne();
                if (getSameSubs &amp;&amp; getSameSubs.user_label !&#x3D;&#x3D; userLabel) {
                    if (latestUserSubscriptions &amp;&amp; latestUserSubscriptions.end_date &lt;&#x3D; new Date()){
                         const cross_payment &#x3D; this.crossPlatformSubsCheck(user, latestUserSubscriptions, currency);
                         return cross_payment;
                    }
                    return {
                        member_type : currentUser[&#x27;member_type&#x27;],
                        validity: false,
                        lastReceipt: {},
                        latestSubscription: latestUserSubscriptions,
                    }      
                }
            }

            if (purchaseData.receipt &#x3D;&#x3D; &quot;&quot; &amp;&amp; latestUserSubscriptions) {
                if (latestUserSubscriptions.end_date &gt; new Date()) {
                    await this.userService.updateMemberType(user.sub, member_type.PAID);
                    afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                            .getRawOne();
                    return {
                        member_type : afterUser[&#x27;member_type&#x27;],
                        validity: true,
                        lastReceipt: {},
                        latestSubscription: latestUserSubscriptions
                    }
                }

                if (latestUserSubscriptions.end_date &lt;&#x3D; new Date()) {

                    const appleSubStatus &#x3D; await AppleBilling.checkUserSubsToApple(latestUserSubscriptions.subscription_id);
                    purchaseDate &#x3D; appleSubStatus.purchaseDate;
                    expiryDate &#x3D; appleSubStatus.expiresDate;
                    appleProductId &#x3D; appleSubStatus.productId;
                    appleTransactionId &#x3D; appleSubStatus.transactionId;
                    appleOriginalTransactionId &#x3D; appleSubStatus.originalTransactionId;
                    applePurchaseToken &#x3D; latestUserSubscriptions.purchase_token;
                    receiptData &#x3D; appleSubStatus;
                }
            }

            if(purchaseData.receipt &#x3D;&#x3D; &quot;&quot; &amp;&amp; !latestUserSubscriptions) {
                await this.userService.updateMemberType(user.sub, member_type.FREE);
                afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                            .getRawOne();
                return {
                    member_type : afterUser[&#x27;member_type&#x27;],
                    validity: false,
                    lastReceipt: {},
                    latestSubscription: {}
                }
            }

            if (purchaseData.receipt !&#x3D;&#x3D;  &quot;&quot;) {
                this.saveSubscriptionLogs(user.label, payment_platforms.APPLE, &#x27;verify.subscription&#x27;, appleOriginalTransactionId, null, JSON.stringify(purchaseData), JSON.stringify(receiptData))
            };

            const startDate &#x3D; moment(parseInt(purchaseDate)).format();
            const dateExpiry &#x3D; moment(parseInt(expiryDate)).format();

            const subPlan &#x3D; await this.getSubPLan(appleProductId, currency);

            const subData &#x3D; {
                start_date: startDate,
                end_date: dateExpiry,
                subscription_ref_code: appleProductId,
                order_id: appleOriginalTransactionId,
                purchase_token: applePurchaseToken,
                status: subscription_status.ACTIVE,
                original_fee: subPlan[&#x27;subscription_fee&#x27;],
                currency: subPlan[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
            }

            const paymentData &#x3D; {
                subscription_ref_code: appleProductId,
                paid_fee: subPlan[&#x27;subscription_fee&#x27;],
                status: payment_status.PAID,
                currency: subPlan[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
                payment_method: payment_method.APPLE,
                original_transaction_id: appleOriginalTransactionId,
                transaction_id: appleTransactionId
            }

            if( dateExpiry &lt;&#x3D; moment().format() ) {
                subData.status &#x3D; subscription_status.INACTIVE;
                await this.userService.updateMemberType(user.sub, member_type.FREE);
                Logger.info(&#x60;Inactivate member type ${user.sub}&#x60;)
            } else {
                await this.userService.updateMemberType(user.sub, member_type.PAID);
                Logger.info(&#x60;Activate member type ${user.sub}&#x60;)
            }

            await this.upsertSubscription(subData, user);
            await this.insertUserPayment(paymentData, user);

            // If member claim free trial on this subscription update member status claim trial
            if (purchaseData.receipt !&#x3D;&#x3D; &quot;&quot;) {
                if(receiptData[&#x27;is_trial_period&#x27;] &#x3D;&#x3D; &quot;true&quot;) {
                    await this.userService.updateFreeTrial(user.sub, true);
                }
            }

            afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
            .getRawOne();

            return {
                member_type : afterUser[&#x27;member_type&#x27;],
                validity : dateExpiry &gt;&#x3D; moment().format() ? true : false,
                lastReceipt : receiptData,
                latestSubscription: latestUserSubscriptions
            }

        }catch(err) {
            const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.VERIFY_APPLE_FAILED&#x27;, { lang: await userLang(user) })
            Logger.error(message, { user: user, error : err });
            const error &#x3D; [{ &quot;subscription&quot; : message }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.NOT_FOUND);
        }
    }

    async crossPlatformSubsCheck(user, latestSubs: any, currency) : Promise&lt;Object&gt; {
        // let startDate;
        // let dateExpiry;
        let subPlan;
        let subData;
        let paymentData;
        let afterUser;

        const userLabel &#x3D; user[&#x27;label&#x27;];
        const subs_ref &#x3D; latestSubs.sub_subscription_ref_code;

        try {
            const currentPayment &#x3D; await this.userPaymentRepository
                .createQueryBuilder(&#x27;payment&#x27;)
                .select([
                    &#x27;payment.payment_method as payment_method&#x27;
                ])
                .where(&#x27;payment.user_label &#x3D; :label&#x27;, 
                    { 
                        label: userLabel,
                    })
                .orderBy(&#x27;payment._updated_at&#x27;, &#x27;DESC&#x27;)
                .getRawOne();

            if (currentPayment.payment_method &#x3D;&#x3D; payment_method.APPLE) {
                const appleSubStatus &#x3D; await AppleBilling.checkUserSubsToApple(latestSubs.subscription_id);
                const purchaseDate &#x3D; appleSubStatus.purchaseDate;
                const expiryDate &#x3D; appleSubStatus.expiresDate;
                const appleProductId &#x3D; appleSubStatus.productId;
                const appleTransactionId &#x3D; appleSubStatus.transactionId;
                const appleOriginalTransactionId &#x3D; appleSubStatus.originalTransactionId;
                const applePurchaseToken &#x3D; latestSubs.purchase_token;
                const receiptData &#x3D; appleSubStatus;

                const startDateApple &#x3D; moment(parseInt(purchaseDate)).format();
                const dateExpiryApple &#x3D; moment(parseInt(expiryDate)).format();

                subPlan &#x3D; await this.getSubPLan(appleProductId, currency);

                subData &#x3D; {
                    start_date: startDateApple,
                    end_date: dateExpiryApple,
                    subscription_ref_code: appleProductId,
                    order_id: appleOriginalTransactionId,
                    purchase_token: applePurchaseToken,
                    status: subscription_status.ACTIVE,
                    original_fee: subPlan[&#x27;subscription_fee&#x27;],
                    currency: subPlan[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
                }

                paymentData &#x3D; {
                    subscription_ref_code: appleProductId,
                    paid_fee: subPlan[&#x27;subscription_fee&#x27;],
                    status: payment_status.PAID,
                    currency: subPlan[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
                    payment_method: payment_method.APPLE,
                    original_transaction_id: appleOriginalTransactionId,
                    transaction_id: appleTransactionId
                }

                if( dateExpiryApple &lt;&#x3D; moment().format() ) {
                    subData.status &#x3D; subscription_status.INACTIVE;
                    await this.userService.updateMemberType(user.sub, member_type.FREE);
                    Logger.info(&#x60;Inactivate member type ${user.sub}&#x60;)
                } else {
                    await this.userService.updateMemberType(user.sub, member_type.PAID);
                    Logger.info(&#x60;Activate member type ${user.sub}&#x60;)
                }

                await this.upsertSubscription(subData, user);
                await this.insertUserPayment(paymentData, user);

                
                if(receiptData[&#x27;is_trial_period&#x27;] &#x3D;&#x3D; &quot;true&quot;) {
                    await this.userService.updateFreeTrial(user.sub, true);
                }
                

                afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                .getRawOne();

                return {
                    member_type : afterUser[&#x27;member_type&#x27;],
                    validity : dateExpiryApple &gt;&#x3D; moment().format() ? true : false,
                    lastReceipt : receiptData,
                    latestSubscription: latestSubs
                }
            }

            if (currentPayment.payment_method &#x3D;&#x3D; payment_method.GOOGLE) {
                const getUserSubscriptionLog &#x3D; await this.subscriptionLogsRepository
                    .createQueryBuilder(&#x27;sublogs&#x27;)
                    .select([&#x27;sublogs.request_body as request_body&#x27;])
                    .where(&#x27;sublogs.user_label &#x3D; :label&#x27;, { label: userLabel })
                    .orderBy(&#x27;sublogs.created_at&#x27;, &#x27;DESC&#x27;)
                    .getRawOne();

                const currentToken &#x3D; JSON.parse(getUserSubscriptionLog.request_body.receipt);
                const sendToken &#x3D; currentToken[&#x27;purchaseToken&#x27;];
                
                const googleSubscriptionId &#x3D; latestSubs.subscription_id;
                const googleProductId &#x3D; latestSubs.sub_subscription_ref_code;
                const googleProductToken &#x3D; sendToken;

                const data &#x3D; await GoogleBilling.getsubscriptionDetail(googleProductId, googleProductToken);
                // handling purchase data was dissapear from google
                if(data.code &#x3D;&#x3D; 410){
                    await this.userService.updateMemberType(user.sub, member_type.FREE);
                    afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                                    .getRawOne();
                    return {
                        member_type : afterUser[&#x27;member_type&#x27;],
                        validity: false,
                        lastReceipt: {},
                        latestSubscription: {}
                    }
                }

                if (data.acknowledgementState &#x3D;&#x3D; 0) {
                    throw new Error(&#x27;Subscription not acknowledge&#x27;);
                }

                const startDateGoogle &#x3D; moment(parseInt(data.startTimeMillis)).format();
                const dateExpiryGoogle &#x3D; moment(parseInt(data.expiryTimeMillis)).format();
                subPlan &#x3D; await this.getSubPLan(googleProductId);
                const subscriptionStatus &#x3D; !!data.userCancellationTimeMillis ? subscription_status.INACTIVE : subscription_status.ACTIVE;

                subData &#x3D; {
                    start_date: startDateGoogle,
                    end_date: dateExpiryGoogle,
                    subscription_ref_code: googleProductId,
                    order_id: googleSubscriptionId,
                    purchase_token: JSON.stringify(currentToken),
                    status: subscriptionStatus,
                    original_fee: subPlan[&#x27;subscription_fee&#x27;],
                }

                paymentData &#x3D; {
                    subscription_ref_code : googleSubscriptionId,
                    paid_fee: subPlan[&#x27;subscription_fee&#x27;],
                    status : payment_status.PAID,
                    currency : subPlan[&#x27;currency&#x27;] || &#x27;HKD&#x27;,
                    payment_method : payment_method.GOOGLE,
                    payment_info : JSON.stringify(currentToken)
                }

                if( dateExpiryGoogle &lt;&#x3D; moment().format() ) {
                    subData.status &#x3D; subscription_status.INACTIVE;
                    await this.userService.updateMemberType(user.sub, member_type.FREE);
                } else {
                    await this.userService.updateMemberType(user.sub, member_type.PAID);
                }

                await this.upsertSubscription(subData, user);
                await this.insertUserPayment(paymentData, user);

                // If member claim free trial on this subscription update member status claim trial
                if(data &amp;&amp; data.paymentState &#x3D;&#x3D; 2) {
                    await this.userService.updateFreeTrial(user.sub, true);
                }

                afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                                    .getRawOne();
                return {
                    member_type : afterUser[&#x27;member_type&#x27;],
                    validity : dateExpiryGoogle &gt;&#x3D; moment().format() ? true : false,
                    lastReceipt: data,
                    latestSubscription: latestSubs
                }
            }

            if (currentPayment.payment_method &#x3D;&#x3D; payment_method.STRIPE) {
                afterUser &#x3D; await this.userService.getUser(user.sub ?? user[&#x27;_id&#x27;], null)
                .getRawOne();

                return {
                    member_type : afterUser[&#x27;member_type&#x27;],
                    validity : latestSubs.end_date &gt;&#x3D; moment().format() ? true : false,
                    lastReceipt : {},
                    latestSubscription: latestSubs
                }
            }
        } catch (error) {
            Logger.error(&#x60;Subscription not found, error:${error}&#x60;);
        }

    }

    // New Subscription Flow
    // eslint-disable-next-line @typescript-eslint/ban-types
    async createCustomer(user : any, createCustomerData : CreateCustomerDto, auth : any) : Promise&lt;Object&gt; {

        if(user.member_type &#x3D;&#x3D; member_type.PAID) {
            const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.USER_HAS_ACTIVE_SUBSCRIPTION&#x27;, { lang: await userLang(auth)});
            Logger.error(&#x60;CreateCustomer failed : ${message}&#x60;);
            const error &#x3D; [{ &quot;CreateCustomer&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
        }

        const customer &#x3D; await this.stripe.createCustomer(user, null, createCustomerData)
        if(!customer[&#x27;id&#x27;]) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_CREATE&#x27;, { lang: await userLang(auth) });
            Logger.error(&#x60;CreateCustomer: ${customer[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, error : customer});
            const error &#x3D; [{ &quot;CreateCustomer&quot; : message }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        return customer;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async createPaymentMethod(user : any, createPaymentData : CreatePaymentMethodDto, auth : any) : Promise&lt;Object&gt; {

        if(user.member_type &#x3D;&#x3D; member_type.PAID) {
            const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.USER_HAS_ACTIVE_SUBSCRIPTION&#x27;, { lang: await userLang(auth)});
            Logger.error(&#x60;CreatePaymentMethod failed : ${message}&#x60;);
            const error &#x3D; [{ &quot;CreatePaymentMethod&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
        }

        const createpayment &#x3D; await this.stripe.createPaymentMethod(createPaymentData, user)

        if(!createpayment[&#x27;id&#x27;]) {
            Logger.error(&#x60;CreatePaymentMethod failed : ${createpayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, error : createpayment});
            const error &#x3D; [{ &quot;CreatePaymentMethod&quot; : &#x60;${createpayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Create payment method failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }
        return createpayment;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async createSubscription(user : any, createSubscriptionnData : CreateSubscriptionDto) : Promise&lt;Object&gt; {
        if(user.member_type &#x3D;&#x3D; member_type.PAID) {
            const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.USER_HAS_ACTIVE_SUBSCRIPTION&#x27;, { lang: await userLang(user)});
            Logger.error(&#x60;CreateSubscription failed : ${message}&#x60;);
            const error &#x3D; [{ &quot;CreateSubscription&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
        }

        // if(createSubscriptionnData[&#x27;claim_trial&#x27;] &amp;&amp; await this.userService.isFreeTrialClaimed(user.sub)) {
        //     Logger.error(&#x60;Claim free trial error : Free trial has been claimed for this user}&#x60;, {data : createSubscriptionnData});
        //     const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.FREE_TRIAL_ALREADY_CLAIMED&#x27;, { lang: await userLang(user)});
        //     const error &#x3D; [{ &quot;ClaimFreeTrial&quot; : message }];
        //     throw new HttpException(await this.response.response( message, null, error), HttpStatus.INTERNAL_SERVER_ERROR);
        // }

        if(createSubscriptionnData[&#x27;claim_trial&#x27;]) {
            if( createSubscriptionnData[&#x27;price_id&#x27;] !&#x3D; stripe_price_id.MONTHLY) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.FREE_TRIAL_ONLY_FOR_MONTHLY&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim free trial error : ${message}&#x60;, {data : createSubscriptionnData});
                const error &#x3D; [{ &quot;ClaimFreeTrial&quot; : message }];
                throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
            }
            if( await this.userService.isFreeTrialClaimed(user.sub)) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.FREE_TRIAL_ALREADY_CLAIMED&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim free trial error : ${message}&#x60;, {data : createSubscriptionnData});
                const error &#x3D; [{ &quot;ClaimFreeTrial&quot; : message }];
                throw new HttpException(await this.response.response( message, null, error), HttpStatus.BAD_REQUEST);
            }
        }

        if(createSubscriptionnData[&#x27;referral_code&#x27;]) {
            const existing_payment &#x3D; await this.getPaidPaymentByUserLabel(user.label);

            if(existing_payment.length &gt; 0) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.REFERRAL_ONLY_FOR_NEW_USER&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim referral code error : ${message}&#x60;);
                const error &#x3D; [{ &quot;ClaimReferralCode&quot; : message }];
                throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
            }

            if(await this.userService.isReferralCodeClaimed(user.sub)) {
                // const message &#x3D; &quot;Referral code has been claimed for this user&quot;
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.REFERRAL_ALREADY_CLAIMED&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim referral code error : ${message}&#x60;, {user:user});
                const error &#x3D; [{ &quot;ClaimReferralCode&quot; : message }];
                throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
            }
            const isReferralCodeValid &#x3D; await this.checkReferralCode(createSubscriptionnData[&#x27;referral_code&#x27;]);
            if(!isReferralCodeValid) {
                const message &#x3D; await this.i18n.translate(&#x27;message.SUBSCRIPTION.REFERRAL_INVALID&#x27;, { lang: await userLang(user)});
                Logger.error(&#x60;Claim referral code error : ${message}&#x60;, {user:user, referral_code : createSubscriptionnData[&#x27;referral_code&#x27;]});
                const error &#x3D; [{ &quot;ClaimReferralCode&quot; : message }];
                throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
            }
        }

        const paymentMethod &#x3D; await this.stripe.attachPaymentMethodToUser(createSubscriptionnData.paymentmethod_id, createSubscriptionnData.customer_id);
        if(!paymentMethod[&#x27;id&#x27;]) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_CREATE&#x27;, { lang: await userLang(user) });
            Logger.error(&#x60;AttachPaymentMethod: ${paymentMethod[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data : paymentMethod});
            const error &#x3D; [{ &quot;AttachPaymentMethod&quot; : paymentMethod[&#x27;raw&#x27;][&#x27;message&#x27;] }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }


        await this.userService.updateStripeId(user, createSubscriptionnData.customer_id)
        Logger.info(&#x60;Save stripeId ${createSubscriptionnData.customer_id} to user&#x60;, {user:user});

        await this.savePaymentMethod(paymentMethod[&#x27;id&#x27;], user.sub, user.email),
        Logger.info(&#x60;Success save payment method&#x60;, {user:user, data : paymentMethod});

        // Set created payment method as default on stripe
        const defaultPayment &#x3D; await this.stripe.setDefaultPaymentMethod(createSubscriptionnData.customer_id, paymentMethod[&#x27;id&#x27;])
        if(!defaultPayment[&#x27;id&#x27;]) {
            Logger.error(&#x60;Set default payment method failed: ${defaultPayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data : defaultPayment});
            const error &#x3D; [{ &quot;PaymentMethod&quot; : &#x60;${defaultPayment[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Attach payment method failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }

        Logger.info(&#x60;Successfully set default payment method ${defaultPayment[&#x27;id&#x27;]} to ${defaultPayment[&#x27;id&#x27;]}&#x60;, {user:user, data : defaultPayment});

        // const add7Days &#x3D; moment().add(7, &#x27;days&#x27;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;);
        const addFreeTrial &#x3D; moment().add(freeTrialValue, &#x27;hours&#x27;).format(&quot;YYYY-MM-DD HH:mm:ss&quot;);
        const trialEnd &#x3D; createSubscriptionnData.claim_trial? moment(new Date(addFreeTrial)).format(&#x27;X&#x27;) : null;
        const couponId &#x3D; createSubscriptionnData[&#x27;promo_code&#x27;];
        const subscribe &#x3D; await this.stripe.createSubscription(createSubscriptionnData.customer_id, createSubscriptionnData.price_id, parseInt(trialEnd))
        if(!subscribe[&#x27;id&#x27;]) {
            Logger.error(&#x60;Proccess subscription : ${subscribe[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data : subscribe});
            const error &#x3D; [{ &quot;ProccessSubscription&quot; : &#x60;${subscribe[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            throw new HttpException(await this.response.response(&#x27;Create subscription failed&#x27;, null, error), HttpStatus.BAD_REQUEST);
        }
        // If free trial claimed, set claim_referralcode to true
        if (trialEnd !&#x3D; null &amp;&amp; subscribe[&#x27;id&#x27;]) {
            await this.userService.updateFreeTrial(user.sub, true)
            Logger.info(&#x60;Free trial claimed on user ${user.sub}&#x60;);
        }

        Logger.info(&#x60;Successfully subscribe with id ${subscribe[&#x27;id&#x27;]}}&#x60;, {user:user, data : subscribe});

        const result &#x3D; await this.getPaymentDataFromSubscribeResponse(subscribe)

        await this.insertSubscriptionData(result, user.sub, createSubscriptionnData.price_id, createSubscriptionnData.referral_code)

        return subscribe;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async previewInvoice(subscription_id : string, customer_id : string, price_id : string) : Promise&lt;Object&gt;{

        if(!subscription_id || !customer_id || !price_id) {
            Logger.error(&#x60;Subscription_id, Customer_id, and Price_id cannot be empty&#x60;);
            const error &#x3D; [{ &quot;GetUpcomingInvoice&quot; : &#x60;Subscription_id, Customer_id, and Price_id cannot be empty&#x60; }];
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }

        const subscription &#x3D; await this.stripe.getSubscription(subscription_id);
        if(!subscription[&#x27;id&#x27;]) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            Logger.error(&#x60;GetSubscription: ${subscription[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;GetSubscription&quot; : subscription[&#x27;raw&#x27;][&#x27;message&#x27;] }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }

        const invoice &#x3D; await this.stripe.getUpcomingInvoice(customer_id, price_id, subscription);
        if(invoice[&#x27;object&#x27;] !&#x3D; &#x27;invoice&#x27;) {
            Logger.error(&#x60;Failed get upcoming invoice: ${invoice[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;GetUpcomingInvoice&quot; : &#x60;${invoice[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }

        return invoice;

    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async deleteSubscription(subscription_id : string, user) : Promise&lt;Object&gt;{
        const user_data &#x3D; await this.userService.getUser(user.sub, null).getRawOne()
        const stripe_subs_id &#x3D; await this.userSubscriptionRepository
        .createQueryBuilder(&#x27;user_subscription&#x27;)
        .select([
            &#x27;user_subscription.order_id as order_id&#x27;,
            &#x27;user_subscription.status as status&#x27;,
            &#x27;user_subscription.enddate as end_date&#x27;
        ])
        .where(&#x27;user_subscription.order_id like :pattern AND user_subscription.user_label &#x3D; :label&#x27;, { pattern: &#x60;%sub_%&#x60;, label: user_data[&#x27;label&#x27;] })
        .limit(1)
        .orderBy(&#x27;user_subscription._updated_at&#x27;, &#x27;DESC&#x27;)
        .getRawMany();
        let latest_stripe_id &#x3D; null;
        if(stripe_subs_id.length &#x3D;&#x3D; 0){
            Logger.error(&#x60;UpdateSubscription : No stripe subcription data from user&#x60;);
            const message &#x3D;   await this.i18n.translate(&#x27;message.GENERAL.ERROR.NOT_FOUND&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;UpdateSubscription&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.NOT_FOUND);
        } else if (stripe_subs_id[0].end_date &lt; new Date() || stripe_subs_id[0].status &#x3D;&#x3D; &#x27;INACTIVE&#x27;){
            Logger.error(&#x60;UpdateSubscription : No stripe subcription data from user&#x60;);
            const message &#x3D;   await this.i18n.translate(&#x27;message.GENERAL.ERROR.NOT_FOUND&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;UpdateSubscription&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.NOT_FOUND);
        } else {
            latest_stripe_id &#x3D; stripe_subs_id[0].order_id;
        }

        const data &#x3D; await this.getUserSubscription(null, latest_stripe_id, null)
        

        if(data[&#x27;user_label&#x27;] !&#x3D; user_data[&#x27;label&#x27;]) {
            Logger.error(&#x60;UpdateSubscription : Subcription data owned by another user, unauthorized&#x60;);
            const message &#x3D;   await this.i18n.translate(&#x27;message.USER.UNAUTHORIZED&#x27;, { lang: await userLang(null) })
            const error &#x3D; [{ &quot;UpdateSubscription&quot; : message }];
            throw new HttpException(await this.response.response( message, null, error), HttpStatus.UNAUTHORIZED);
        }
        const deletedSubscription &#x3D; await this.stripe.updateSubscription(latest_stripe_id, true, null, null);
        // const deletedSubscription &#x3D; await this.stripe.deleteSubscription(latest_stripe_id);
        console.log({user_Data: user.sub})
        await this.userService.updateMemberType(user.sub, member_type.FREE);
        await this.userSubscriptionRepository.update(
                        {order_id : latest_stripe_id, user_label: user_data[&#x27;label&#x27;]}, 
                        {status : subscription_status.INACTIVE, _updated_at : moment().format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;), enddate: moment().subtract(60, &#x27;seconds&#x27;).format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;)}
                    );
        if(!deletedSubscription[&#x27;id&#x27;]){
            Logger.error(&#x60;Failed delete subscription: ${deletedSubscription[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;DeleteSubscription&quot; : &#x60;${deletedSubscription[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_DELETE&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        return deletedSubscription;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async listSubscriptionByUser(customer_id : string) : Promise&lt;Object&gt;{
        if(!customer_id) {
            Logger.error(&#x60;Customer_id cannot be empty&#x60;);
            const error &#x3D; [{ &quot;GetUpcomingInvoice&quot; : &#x60;Customer_id cannot be empty&#x60; }];
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        const subscriptions &#x3D; await this.stripe.listSubscription(customer_id);
        if(!subscriptions[&#x27;object&#x27;]){
            Logger.error(&#x60;Failed get subscription: ${subscriptions[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;GetSubscription&quot; : &#x60;${subscriptions[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        return subscriptions;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async updateSubscription(user : any, updateSubscriptionData : UpdateSubscriptionDto) : Promise&lt;Object&gt;{
        const subscription &#x3D; await this.stripe.getSubscription(updateSubscriptionData.subscription_id);
        if(!subscription[&#x27;id&#x27;]) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_CREATE&#x27;, { lang: await userLang(null) });
            Logger.error(&#x60;UpdateSubscription: ${subscription[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data : subscription});
            const error &#x3D; [{ &quot;CreateCuUpdateSubscriptionstomer&quot; : subscription[&#x27;raw&#x27;][&#x27;message&#x27;] }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        Logger.info(&#x60;Successfully find subscription ${subscription[&#x27;id&#x27;]}}&#x60;);

        const updateSubscription &#x3D; await this.stripe.updateSubscription(subscription[&#x27;id&#x27;], false, subscription[&#x27;items&#x27;].data[0].id, updateSubscriptionData.price_id)
        if(!updateSubscription[&#x27;id&#x27;]) {
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.UNPROCESSED_CREATE&#x27;, { lang: await userLang(null) });
            Logger.error(&#x60;UpdateSubscription: ${updateSubscription[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;, {user:user, data : updateSubscription});
            const error &#x3D; [{ &quot;UpdateSubscription&quot; : updateSubscription[&#x27;raw&#x27;][&#x27;message&#x27;] }];
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }

        Logger.info(&#x60;Successfully update subscription ${updateSubscription[&#x27;id&#x27;]}}&#x60;, {user:user, data : updateSubscription});
        return updateSubscription;
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async pausePaymentCollectionSubscription(subscription_id : string, extra_date : string) : Promise&lt;void&gt;{

        const resume &#x3D; moment(extra_date).format(&#x27;X&#x27;);

        const subscription &#x3D; await this.stripe.pausePaymentCollectionSubscription(subscription_id, parseInt(resume));

        if(!subscription[&#x27;id&#x27;]) {
            Logger.error(&#x60;Failed to pause payment collection&#x60;, {error : subscription[&#x27;raw&#x27;][&#x27;message&#x27;]});
        }

        Logger.info(&#x60;Successfully pause payment collection ${subscription[&#x27;id&#x27;]}}&#x60;);
    }

    async addFreeTrial(subscription_id: string, end_date: string) {
        const trial_end &#x3D; moment(end_date).format(&#x27;X&#x27;)
        const subscription &#x3D; await this.stripe.addFreeTrial(subscription_id, parseInt(trial_end));

        if (!subscription[&#x27;id&#x27;]) {
            Logger.error(&#x60;Failed to claim free trial&#x60;, {error : subscription[&#x27;raw&#x27;][&#x27;message&#x27;]});
        }

        Logger.info(&#x60;Successfully claim free trial for ${subscription[&#x27;id&#x27;]}}&#x60;);
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async getSetupIntent(id : string) : Promise&lt;Object&gt;{
        if(!id) {
            Logger.error(&#x60;Setup Intent ID cannot be empty&#x60;);
            const error &#x3D; [{ &quot;GetSetupIntent&quot; : &#x60;Setup Intent ID cannot be empty&#x60; }];
            const message &#x3D;  await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        const setupIntent &#x3D; await this.stripe.retrieveSetupIntent(id);
        if(!setupIntent[&#x27;id&#x27;]){
            Logger.error(&#x60;Failed get setup intent: ${setupIntent[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60;);
            const error &#x3D; [{ &quot;GetSetupIntent&quot; : &#x60;${setupIntent[&#x27;raw&#x27;][&#x27;message&#x27;]}&#x60; }];
            const message &#x3D; await this.i18n.translate(&#x27;message.GENERAL.ERROR.INVALID_GET_DATA&#x27;, { lang: await userLang(null) });
            throw new HttpException(await this.response.response(message, null, error), HttpStatus.BAD_REQUEST);
        }
        return setupIntent;
    }

    async getExportDataSubscription() {
        const data &#x3D; await this.userSubscriptionRepository
        .createQueryBuilder(&#x27;subscription&#x27;)
        .leftJoin(UserEntity, &#x27;user&#x27;,&#x27;user.user_label &#x3D; subscription.user_label&#x27;)
        .leftJoin(SubscriptionPlanEntity, &#x27;plan&#x27;,&#x27;plan.ref_code &#x3D; subscription.subscription_ref_code&#x27;)
        .select([
            &#x27;subscription._id as id&#x27;,
            &#x27;subscription._owner_id as owner_id&#x27;,
            &#x27;user.email as email&#x27;,
            &#x27;user.deleted_at as user_deleted_at&#x27;,
            &#x27;subscription.subscription_ref_code as subscription_ref_code&#x27;,
            &#x27;plan.subscription_type as subscription_plan&#x27;,
            &#x27;subscription.status as status&#x27;,
            &#x27;subscription.startdate as startdate&#x27;,
            &#x27;subscription.enddate as enddate&#x27;,
            &#x27;subscription.order_id as order_id&#x27;,
            &#x27;subscription.payment_id as payment_id&#x27;,
            &#x27;subscription.user_label as user_label&#x27;,
            &#x27;subscription.extra_enddate as extra_enddate&#x27;,
            &#x27;subscription.referral_code as referral_code&#x27;,
            &#x27;subscription.is_referral_bonus_claimed as is_referral_bonus_claimed&#x27;,
            &#x27;subscription._created_at as created_at&#x27;
        ])
        .where(&#x27;user._id IS NOT NULL&#x27;)
        .andWhere(&#x27;user.deleted_at IS NULL&#x27;)
        .getRawMany();
        return data;
    }

    async saveSubscriptionLogs(user_label : string, platform : string, resource_name : string, resource_id : string, webhooks_url : string, request_body : Json, response_body : Json){


        try{
            const log &#x3D; new SubscriptionLogsEntity()
            log.user_label &#x3D; user_label
            log.type &#x3D; platform
            log.transaction_name &#x3D; resource_name
            log.transaction_id &#x3D; resource_id
            log.webhooks_url &#x3D; webhooks_url
            log.request_body &#x3D; request_body
            log.response_body &#x3D; response_body

            await log.save();
            Logger.info(&#x60;Success insert logs ${resource_id}&#x60;);

        } catch (err) {

            Logger.error(&#x60;Failed to save subscription logs resourceId: ${resource_id}, error:${err}&#x60;);
        }
    }

    // eslint-disable-next-line @typescript-eslint/ban-types
    async exportCsv(res){
        const fields &#x3D; [
            {
                label: &#x27;User Email&#x27;,
                value: &#x27;email&#x27;
              },
              {
                label: &#x27;Plan&#x27;,
                value: &#x27;subscription_plan&#x27;
              },
              {
                label: &#x27;Subscription Status&#x27;,
                 value: &#x27;status&#x27;
               },
              {
                label: &#x27;Start Date&#x27;,
                 value: &#x27;startdate&#x27;
               },
               {
                label: &#x27;End Date&#x27;,
                 value: &#x27;enddate&#x27;
               },
               {
                label: &#x27;Extra End Date&#x27;,
                 value: &#x27;extra_enddate&#x27;
               },
               {
                label: &#x27;Referral Code&#x27;,
                 value: &#x27;referral_code&#x27;
               },
          ];

        const subscriptionData &#x3D; await this.getExportDataSubscription();

        const data &#x3D; subscriptionData.map(subscription &#x3D;&gt; ({
            ...subscription,
            startdate: moment(subscription.startdate).add(8, &#x27;hours&#x27;).format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;),
            enddate: moment(subscription.enddate).add(8, &#x27;hours&#x27;).format(&#x27;YYYY-MM-DD HH:mm:ss&#x27;)
        }));
        // return data;
        const time &#x3D; moment().format(&#x27;YYYYMMDDHHmmss&#x27;);
        return this.exportFile.csv(res, &#x27;subscription_&#x27;+time+&#x27;.csv&#x27;, fields, data);
    }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'SubscriptionService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
